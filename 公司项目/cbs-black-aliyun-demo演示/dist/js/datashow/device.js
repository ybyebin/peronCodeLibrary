function loadAllDeviceData(){$.ajax({url:apiurl+"subsystem",type:"get",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if($(".loading").hide(),e.success){if(null===e.data.items||0===e.data.items)return void layer.msg("未配置监控系统");AllGroupData=e.data.items,showAllDeviceData(e.data.items),null!==e.data.items[0].view&&($("#wraplist li:first-child a").click(),$("#demo-li0 li:first-child a").click())}},error:function(e){publicAjaxError(e)}})}function showAllDeviceData(e){$("#main-menu-wrapper .wraplist");if(0!==e.length){null===e[0].view&&!1;for(var a in e)switch(e[a].name){case"空调机组":addSlide(e,a,"kongtiao");break;case"视频监控":addSlide(e,a,"vedio");break;case"照明":addSlide(e,a,"zhaoming");break;case"停车场":addSlide(e,a,"tingche");break;case"风机末端":addSlide(e,a,"fengji");break;case"视频监控系统":addSlide(e,a,"vedio");break;case"入侵报警系统":addSlide(e,a,"ruqin");break;case"环境监测系统":addSlide(e,a,"huanjing");break;case"风机盘管":addSlide(e,a,"fengji");break;case"电梯系统":addSlide(e,a,"dianti");break;case"照明控制系统":addSlide(e,a,"zhaoming");break;case"给排水系统":addSlide(e,a,"jishui");break;default:addSlide(e,a,"custom")}}}function addSlide(e,a,t){var n=$('<ul id="demo-li'+a+'" class="sub-views" ></ul>');if(null===e[a].view)n.append('<li><p class="p-no-subviews">尚未添加监控画面</p></li>');else for(var s in e[a].view)n.append('<li><a data-viewid="'+e[a].view[s].id+'">'+e[a].view[s].name+"</a></li>");var o='<li class="device-li"><a class="list-a-click" data-target="#demo-li'+a+'" data-status="close"><i class="'+t+'"></i><span>'+e[a].name+"</span></a></li>";$("#wraplist").append(o),$("#main-menu-wrapper").append(n),$(".sub-views").mCustomScrollbar({autoHideScrollbar:!0})}function showCanvas(e,a){$.ajax({url:"/api/view/"+e,type:"GET",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(t){if($(".loading").hide(),t.success){imageCanvas.clear();var n=[],s=[];null===t.data.view_data||(n=JSON.parse(t.data.view_data).canvas,s=JSON.parse(t.data.view_data).subCanvas),allComponent={};for(var o in n)"draw2d.Connection"!==n[o].type&&(allComponent[n[o].id]=n[o].userData.Tag.tag_id);$("#SecCanvasFullBtn").html("");for(var i in s){allComponent[s[i].id]=s[i].tag_id;var l='<p><button class="btn boolean-true '+s[i].id+'" data-id="'+s[i].id+'"  data-tag-id="'+s[i].tag_id+'" data-tag-name="'+s[i].tag_name+'" data-tag-type="'+s[i].tag_type+'" data-bingding-status="'+s[i].bingding_status+'" data-readonly="'+s[i].readonly+'"  data-value=""  data-tagreadonly="">'+s[i].name+"</button></p>";$("#SecCanvasFullBtn").append(l)}$("#myBgimage").css("background-image","url()"),$("#canvas").css("background-color","#2B2F4C"),""!==t.data.background_color&&$("#canvas").css("background-color",t.data.background_color),""!==t.data.background_img_url&&null!==t.data.background_img_url&&$("#myBgimage").css("background-image","url("+t.data.background_img_url+")");(new draw2d.io.json.Reader).unmarshal(a,n);(new draw2d.io.json.Writer).marshal(a,function(e){for(var t in e){var n=getCanvasNode(a,e[t].id);if("conduitCompontent"!==n.userData.types&&""==n.userData.havepoint&&(n.getOutputPort(0).setVisible(!1),n.getInputPort(0).setVisible(!1)),"conduitCompontent"===n.userData.types&&n.resetPorts(),n.userData.ShowCaption){switch(e[t].userData.ShowCaption){case!0:n.label.setVisible(!0);break;case!1:n.label.setVisible(!1)}n.label.setText(e[t].userData.Caption),n.label.repaint()}switch(1==n.userData.Blinking&&n.startTimer(1e3),n.image&&(n.image.setHeight(n.getHeight()),n.image.setWidth(n.getWidth())),n.userData.picture&&(n.image.setPath(n.userData.picture),n.image.setHeight(n.getHeight()),n.image.setWidth(n.getWidth()),n.setAlpha(.001)),n.alpha){case 0:n.setAlpha(0),n.image&&n.image.setAlpha(0),n.label&&n.label.setAlpha(0)}}}),getComponentlist(e)}else layer.msg("请求画面失败:"+t.error_message)},error:function(e){publicAjaxError(e)}})}function changeGlobalBtnState(e){if(componentIsReadonly[e]&&0==Number(componentIsReadonly[e].readonly)&&0==componentIsReadonly[e].com_readonly)switch(componentIsReadonly[e].tag_type){case"boolean":layerType=layer.open({title:["指定数据标签值","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["1018px","275px"],content:$("#action1"),shift:2,move:!1,btn:["确定","取消"],success:function(){switch(Number(componentIsReadonly[e].value)){case 0:$("#close").iCheck("check"),$("#open").iCheck("uncheck");break;case 1:$("#close").iCheck("uncheck"),$("#open").iCheck("check")}},yes:function(a){$("#action1").find("input").each(function(a,t){var n=$(t).attr("id");if(1==$("#"+n).prop("checked"))switch(n){case"open":var s={tag_id:componentIsReadonly[e].tag_id,value:1},o=s;changeTagValue("global_btn",o,componentIsReadonly[e].tag_id,componentIsReadonly[e].id);break;case"close":var i={tag_id:componentIsReadonly[e].tag_id,value:0},o=i;changeTagValue("global_btn",o,componentIsReadonly[e].tag_id,componentIsReadonly[e].id)}}),layer.close(layerType)},btn2:function(e){layer.close(layerType)}})}}function getComponentlist(e){$.ajax({url:apiurl+"ViewData/"+e,type:"GET",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){},success:function(e){if($(".loading").hide(),e.success){componentIsReadonly={};for(var a in e.data){var t=e.data[a];componentIsReadonly[e.data[a].id]=t}addComponentMessage(componentIsReadonly),reloadCanvas(componentIsReadonly)}else layer.msg("错误:"+e.error_message)},error:function(e){publicAjaxError(e)}})}function deviceComTrue(e,a){switch(e.stopTimer(),e.userData.BlinkingType="onTrue",e.userData.types){case"LabelComponent":break;default:1==e.userData.onTrue.Blinking&&e.startTimer(1e3),e.setStroke(Number(e.userData.onTrue.LineWidth)),e.setDashArray(e.userData.onTrue.LineStyle),e.setColor(e.userData.onTrue.LineColor)}switch(e.userData.types){case"imageComponent":e.image.setPath(e.userData.onTrue.picture);break;case"buttonComponent":e.setBackgroundColor(e.userData.onTrue.FillColor),""==e.userData.onTrue.Text?e.userData.onTrue.unit?e.setText(String(a+e.userData.onTrue.unit)):e.setText(String(a)):e.setText(e.userData.onTrue.Text),e.setFontColor(e.userData.onTrue.TextColor);break;case"basicComponent":e.setBackgroundColor(e.userData.onTrue.FillColor),e.userData.onTrue.alpha&&e.setAlpha(Number(e.userData.onTrue.alpha))}e.repaint()}function deviceComFalse(e,a){switch(e.stopTimer(),e.userData.BlinkingType="onFalse",e.userData.types){case"LabelComponent":break;default:1==e.userData.onFalse.Blinking&&e.startTimer(1e3),e.setStroke(Number(e.userData.onFalse.LineWidth)),e.setDashArray(e.userData.onFalse.LineStyle),e.setColor(e.userData.onFalse.LineColor)}switch(e.userData.types){case"imageComponent":e.image.setPath(e.userData.onFalse.picture);break;case"buttonComponent":e.setBackgroundColor(e.userData.onFalse.FillColor),""==e.userData.onFalse.Text?e.userData.onFalse.unit?e.setText(String(a+e.userData.onFalse.unit)):e.setText(String(a)):e.setText(e.userData.onFalse.Text),e.setFontColor(e.userData.onFalse.TextColor);break;case"basicComponent":e.setBackgroundColor(e.userData.onFalse.FillColor),e.userData.onFalse.alpha&&e.setAlpha(Number(e.userData.onFalse.alpha))}e.repaint()}function deviceComAlarm(e,a){switch(e.stopTimer(),e.userData.BlinkingType="onAlarm",e.userData.types){case"LabelComponent":break;default:1==e.userData.onAlarm.Blinking&&e.startTimer(1e3),e.setStroke(Number(e.userData.onAlarm.LineWidth)),e.setDashArray(e.userData.onAlarm.LineStyle),e.setColor(e.userData.onAlarm.LineColor)}switch(e.userData.types){case"imageComponent":e.image.setPath(e.userData.onAlarm.picture);break;case"buttonComponent":e.setBackgroundColor(e.userData.onAlarm.FillColor),""==e.userData.onAlarm.Text?e.userData.onAlarm.unit?e.setText(String(a+e.userData.onAlarm.unit)):e.setText(String(a)):e.setText(e.userData.onAlarm.Text),e.setFontColor(e.userData.onAlarm.TextColor);break;case"basicComponent":e.setBackgroundColor(e.userData.onAlarm.FillColor),e.userData.onAlarm.alpha&&e.setAlpha(Number(e.userData.onAlarm.alpha))}e.repaint()}function deviceComDiscon(e,a){switch(e.stopTimer(),e.userData.BlinkingType="onDisconnected",e.userData.types){case"LabelComponent":break;default:1==e.userData.onDisconnected.Blinking&&e.startTimer(1e3),e.setStroke(Number(e.userData.onDisconnected.LineWidth)),e.setDashArray(e.userData.onDisconnected.LineStyle),e.setColor(e.userData.onDisconnected.LineColor)}switch(e.userData.types){case"imageComponent":e.image.setPath(e.userData.onDisconnected.picture);break;case"buttonComponent":e.setBackgroundColor(e.userData.onDisconnected.FillColor),""==e.userData.onDisconnected.Text?e.setText(a):e.setText(e.userData.onDisconnected.Text),e.setFontColor(e.userData.onDisconnected.TextColor);break;case"basicComponent":e.setBackgroundColor(e.userData.onDisconnected.FillColor),e.userData.onDisconnected.alpha&&e.setAlpha(Number(e.userData.onDisconnected.alpha))}e.repaint()}function reloadCanvas(e){for(var a in e)if(isNaN(e[a].id)){var t=getCanvasNode(imageCanvas,e[a].id);if(t.userData.valueType&&0===Number(e[a].status))switch(t.userData.valueType){case"textValueComponent":t.setText(String(e[a].value+t.userData.unit)),t.repaint();break;case"valueComponent":"LabelComponent"===t.userData.types?(t.setText(e[a].value),t.repaint()):(t.label.setText(e[a].value),t.label.repaint())}switch(Number(e[a].status)){case 0:switch(e[a].alarm){case!1:if(1==t.userData.Tag.tag_type)switch(e[a].value){case 0:deviceComFalse(t,e[a].value);break;case 1:deviceComTrue(t,e[a].value);break;case!1:deviceComFalse(t,e[a].value);break;case!0:deviceComTrue(t,e[a].value)}else deviceComTrue(t,e[a].value);break;case!0:deviceComAlarm(t,e[a].value);break;default:if(1==t.userData.Tag.tag_type)switch(e[a].value){case 0:deviceComFalse(t,e[a].value);break;case 1:deviceComTrue(t,e[a].value);break;case!1:deviceComFalse(t,e[a].value);break;case!0:deviceComTrue(t,e[a].value)}else deviceComTrue(t,e[a].value)}break;default:deviceComDiscon(t,"通讯异常")}}else if(null==e[a].value)$("."+e[a].id).data("value","-1");else switch($("."+e[a].id).data("tagreadonly",e[a].readonly),Number(e[a].value)){case 0:$("."+e[a].id).data("value","0").removeClass("boolean-false boolean-true").addClass("boolean-true");break;case 1:$("."+e[a].id).data("value","1").removeClass("boolean-false boolean-true").addClass("boolean-false");break;default:$("."+e[a].id).data("value","-1")}}function addComponentMessage(e){$("#table-stripeds tbody").html("");var a,t,n=$("#table-stripeds tbody").html(),s="<td></td>",o="<td></td>";for(var i in e){var l=!0;switch(e[i].status){case null:s='<td data-status = "-2" class = "tagState">tag无效</td>',o='<td class = "tagsValue">--</td>',l=!1;break;case-1:s='<td data-status = "-1" class = "tagState">tag无效</td>',o='<td class = "tagsValue">--</td>',l=!1;break;case 0:switch(e[i].alarm){case!1:if(1===Number(e[i].tag_type))switch(e[i].value){case 0:s='<td data-status = "0" class = "tagState">正常</td>',o='<td class = "tagsValue">'+e[i].value+"</td>";break;case 1:s='<td data-status = "0" class = "tagState">正常</td>',o='<td class = "tagsValue" >'+e[i].value+"</td>";break;case!1:s='<td data-status = "0" class = "tagState">正常</td>',o='<td class = "tagsValue">'+e[i].value+"</td>";break;case!0:s='<td data-status = "0" class = "tagState">正常</td>',o='<td class = "tagsValue" >'+e[i].value+"</td>"}else s='<td class = "tagState" data-status = "0"></td>',o='<td class = "tagsValue" >'+e[i].value+"</td>";break;case!0:1===Number(e[i].tag_type)?(s='<td data-status = "0" class = "tagState"><span class="warn"></span><span class="size_red">报警</span></td>',o='<td class = "tagsValue">'+e[i].value+"</td>"):(s='<td class = "tagState"><span class="warn"></span><span class="size_red">报警</span></td>',o='<td class = "tagsValue">'+e[i].value+"</td>");break;case null:1===Number(e[i].tag_type)?(s='<td data-status = "0" class = "tagState">正常</td>',o='<td class = "tagsValue">'+e[i].value+"</td>"):(s='<td data-status = "0" class = "tagState"></td>',o='<td class = "tagsValue" >'+e[i].value+"</td>")}break;case 1:s='<td data-status = "1" class = "tagState"><span class="catch"></span><span class="size_yellow">通信异常</span></td>',o='<td class = "tagsValue">--</td>';break;case 2:s='<td data-status = "2" class = "tagState"><span class="catch"></span><span class="size_yellow">通信异常</span></td>',o='<td class = "tagsValue">--</td>';break;default:s='<td data-status = "'+e[i].status+'" class = "tagState"><span class="catch"></span><span class="size_yellow">通信异常</span></td>',o='<td class = "tagsValue">--</td>'}if(l){switch(Number(e[i].trends)){case 0:a="<td >--</td>";break;case 1:a='<td ><a data-id = "'+e[i].tag_id+'" data-name="'+e[i].name+'" class = "watch" href="#">查看</a></td>'}switch(e[i].readonly){case!1:switch(e[i].com_readonly){case!1:t='<td><a class = "doIt" href="#" data-id = "'+e[i].id+'"  data-type="'+e[i].tag_type+'"  data-readonly="'+e[i].readonly+'">操作</a></td>';break;case!0:t="<td >--</td>"}break;case!0:t="<td > --</td>"}}else a="<td >--</td>",t="<td >--</td>";n+='<tr id = "'+e[i].id+'"><td class = "componentName" title="'+e[i].name+'">'+e[i].name+"</td>"+s+o+a+t+'<td style="display:none " class = "havetagid">'+e[i].tag_id+'</td><td style="display:none " class = "havetagtype">'+e[i].tag_type+"</td></tr>"}$("#qu table tbody").html(n)}function detail(e){layer.open({title:[e,"font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,area:["1200px","600px"],content:$("#detail"),shift:2})}function createStockChart(e,a,t){$.ajax({url:apiurl+"tagTrendsData/"+e,type:"GET",dataType:"json",data:{start_time:a,end_time:t+" 23:59:59"},beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if($(".loading").hide(),e.success){var a=e.data.values,t=[];if(null===a);else for(var n in a){var s=[],o=new Date(n).getTime();s.push(o),s.push(Number(a[n])),t.push(s)}$("#quChart").highcharts("StockChart",{chart:{backgroundColor:"#2B2E4B",alignTicks:!1,type:"spline"},tooltip:{formatter:function(){var e="";e+="<span>"+new Date(this.x).format("yyyy-MM-dd hh:mm:ss")+"</span><br/>";for(var a=0;a<this.points.length;a++)e+='<span style="color: '+this.points[a].series.color+'">'+this.points[a].series.name+"</span>: "+this.points[a].y;return e}},rangeSelector:{allButtonsEnabled:!0,enabled:!1,buttonTheme:{width:60},selected:2},title:{text:"历史趋势",style:{color:"#fff",fontWeight:"normal",fontFamily:"微软雅黑",fontSize:"16px"}},navigator:{enabled:!0,xAxis:{lineColor:"#555769",dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H点",day:"%Y年%m月%d日",week:"%e. %b",month:"%Y年%m月",year:"%Y年"}}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!1},xAxis:{labels:{style:{color:"#555769"}},lineColor:"#555769",tickColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"}},yAxis:{gridLineColor:"#555769"},credits:{enabled:!1},series:[{type:"spline",name:"值为",data:t}]})}else layer.msg("错误原因:"+e.error_message)},error:function(e){publicAjaxError(e)}})}function getTagRealTimevalue(e,a){$.ajax({url:apiurl+"tagvalue/"+e,type:"GET",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if(e.success){var t=e.data.values,n=[];if(null===t)tagValueForHighChar=0,clearInterval(tagValueSetInterval);else{for(var s in t){var o=new Date(Date.parse(s.replace(/-/g,"/"))).getTime(),i={x:o,y:Number(t[s])};n.push(i)}var l=0;for(var r in e.data.values)l+=1;0===l?(tagValueForHighChar=0,n.push({x:(new Date).getTime(),y:0})):tagValueForHighChar=n[n.length-1].y,clearInterval(tagValueSetInterval)}Highcharts.setOptions({global:{useUTC:!1}}),$("#quChart1").highcharts({chart:{backgroundColor:"#2B2E4B",type:"spline",animation:Highcharts.svg,marginRight:10,events:{load:function(){var e=this.series[0];tagValueSetInterval=setInterval(function(){var a=(new Date).getTime(),t=tagValueForHighChar;e.addPoint([a,t],!0,!1)},1e4)}}},title:{text:"实时趋势",style:{color:"#fff",fontWeight:"normal",fontFamily:"微软雅黑",fontSize:"16px"}},xAxis:{labels:{style:{color:"#555769"}},lineColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"},tickColor:"#555769",tickLength:10,tickPixelInterval:null,labels:{formatter:function(){return Highcharts.dateFormat("%H:%M:%S",this.value)}}},yAxis:{title:{text:"Value"},gridLineColor:"#555769",plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+'<br/><span style="color: '+this.series.color+'">值为：</span>: '+Highcharts.numberFormat(this.y,2)}},legend:{enabled:!1},exporting:{enabled:!1},credits:{enabled:!1},series:[{color:"#f5a623",name:a,data:n}]})}else layer.msg("实时数据:"+e.error_message)},error:function(e){publicAjaxError(e)}})}function changeComponentState(e){var a=1;if(componentIsReadonly[e]&&0===Number(componentIsReadonly[e].readonly)&&0==componentIsReadonly[e].com_readonly&&(a=0),0==a){var t=componentIsReadonly[e].status;if(0==t||1==t||2==t)switch(Number(componentIsReadonly[e].tag_type)){case 1:layerType=layer.open({title:["指定数据标签值","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["1018px","275px"],content:$("#action1"),shift:2,move:!1,btn:["确定","取消"],success:function(){switch(Number(componentIsReadonly[e].value)){case 0:$("#close").iCheck("check"),$("#open").iCheck("uncheck");break;case 1:$("#close").iCheck("uncheck"),$("#open").iCheck("check")}},yes:function(a){var t=$('#action1 input[name="status"]:checked').attr("id");switch(t){case"open":var n={tag_id:componentIsReadonly[e].tag_id,value:String(1)},s=n;changeTagValue("canvas_com",s,componentIsReadonly[e].tag_id,componentIsReadonly[e].id);break;case"close":var o={tag_id:componentIsReadonly[e].tag_id,value:String(0)},s=o;changeTagValue("canvas_com",s,componentIsReadonly[e].tag_id,componentIsReadonly[e].id)}layer.close(layerType)},btn2:function(e){layer.close(layerType)}});break;case 2:$("#action").find("input").val(componentIsReadonly[e].value),layerForother("canvas_com",componentIsReadonly[e].tag_id,componentIsReadonly[e].id,"2");break;case 3:$("#action").find("input").val(componentIsReadonly[e].value),layerForother("canvas_com",componentIsReadonly[e].tag_id,componentIsReadonly[e].id,"3");break;case 4:$("#action_str").find("input").val(componentIsReadonly[e].value),layerType=layer.open({title:["指定数据标签值","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["1018px","275px"],content:$("#action_str"),shift:2,move:!1,btn:["确定","取消"],yes:function(a){$("#action_str").find("input").val(),changeTagValue("canvas_com",{tag_id:componentIsReadonly[e].tag_id,value:$("#action_str").find("input").val()},componentIsReadonly[e].tag_id,componentIsReadonly[e].id),$("#action_str").find("input").val(""),layer.close(layerType)},btn2:function(e){layer.close(layerType)}});break;default:layer.msg("未绑定Tag")}}}function layerForother(e,a,t,n){layer.open({title:["指定数据标签值","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["1018px","275px"],content:$("#action"),shift:2,move:!1,btn:["确定","取消"],yes:function(s){switch(Number(n)){case 2:if(checkInputNumber($("#dataValue").val())){var o={tag_id:a,value:Number($("#dataValue").val())},i=o;switch(e){case"canvas_com":changeTagValue("canvas_com",i,a,t);break;case"global_btn":changeTagValue("global_btn",i,a,t)}$("#action").find("input").val(""),layer.close(s)}else layer.msg("请输入正确的整数");break;case 3:if(isNaN($("#action").find("input").val()))layer.msg("请输入正确的实数");else{var o={tag_id:a,value:Number($("#action").find("input").val())},i=o;switch(e){case"canvas_com":changeTagValue("canvas_com",i,a,t);break;case"global_btn":changeTagValue("global_btn",i,a,t)}$("#action").find("input").val(""),layer.close(s)}}},btn2:function(e){layer.close(e)}})}function checkInputNumber(e){return!isNaN(e)&&!/^[+-]?[1-9]?[0-9]*\.[0-9]*$/.test(e)}function changeTagValue(e,a,t,n){$.ajax({url:apiurl+"/tagvalue/"+t+"?value="+a.value,type:"put",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(t){if($(".loading").hide(),t.success){if(t.data){switch(e){case"canvas_com":findComponentByComponentid(a.value,n);break;case"global_btn":switch(Number(a.value)){case 0:$("#"+n).find(".tagsValue").text("false"),$("."+n).data("value","0").removeClass("boolean-false boolean-true").addClass("boolean-true");break;case 1:$("#"+n).find(".tagsValue").text("true"),$("."+n).data("value","1").removeClass("boolean-false boolean-true").addClass("boolean-false")}}componentIsReadonly[n].value=a.value,layer.msg("修改成功")}}else layer.msg("修改失败:"+t.error_message)},error:function(e){$(".loading").hide(),layer.msg("修改失败:"+e.error_message)}})}function findComponentByComponentid(e,a){var t=getCanvasNode(imageCanvas,a);if("notCanvasNode"===t);else if(1===Number(t.userData.Tag.tag_type))switch(layer.msg("开关型"),Number(e)){case 0:deviceComFalse(t);break;case 1:deviceComTrue(t)}else if(t.userData.valueType)switch(t.userData.valueType){case"textValueComponent":t.setText(String(e)),t.repaint();break;case"valueComponent":"LabelComponent"===t.userData.types?(t.setText(String(e)),t.repaint()):(t.label.setText(String(e)),t.label.repaint())}if(1==Number($("#"+a).find(".havetagtype").text()))switch(Number(e)){case 0:$("#"+a).find(".tagsValue").text("false"),$("."+a).data("value","0").removeClass("boolean-false boolean-true").addClass("boolean-true");break;case 1:$("#"+a).find(".tagsValue").text("true"),$("."+a).data("value","1").removeClass("boolean-false boolean-true").addClass("boolean-false")}else $("#"+a).find(".tagsValue").text(String(e))}function getCanvasNode(e,a){var t=e.getFigure(a),n=e.getLine(a);return null===t&&null===n?"notCanvasNode":null!==t?t:null!==n?n:void 0}function showTooltips(e){var a=$("#tooltips");if(""!==e.userData.Hint){a.show().html(e.userData.Hint);var t=e.getAbsoluteX()+e.getWidth()/2-a.width()/2+8,n=e.getAbsoluteY()+e.getHeight()+10;a.css({top:n+"px",left:t+"px"})}}function vlc(e,a){$("#vlc_bg").css({display:"block",height:$(document).height()});var t=$(".vlc_box");$("#vlc").find(".rtt").val(a),t.css({left:($("body").width()-t.width())/2-20+"px",top:($(window).height()-t.height())/2+$(window).scrollTop()+"px",display:"block"}),$(".vlc_box h2").find("span.title").text(e),$(".vlc_box").on("click",".vlc_close",function(){$("#vlc_bg,.vlc_box").css("display","none")})}function showOrHideGlobalbtn(){Number($(window).width());"950px"==$("#SecCanvas").css("left")?$("#SecCanvasFullBtn").hasClass("in")&&$("#SecCanvas div.title").click():$("#SecCanvasFullBtn").hasClass("in")||$("#SecCanvas div.title").click()}function startmove(e,a,t){var n=document.getElementById("main-menu-wrapper");clearInterval(timer),timer=setInterval(function(){n.offsetLeft==a?clearInterval(timer):(0===e?$(".handle").addClass("open"):$(".handle").removeClass("open"),n.style.left=n.offsetLeft+t+"px")},10)}!function(e){e(window).load(function(){e("#div-wraplist").mCustomScrollbar({autoHideScrollbar:!0}),e(".scrollFullBtn").mCustomScrollbar(),e(".qu-scroll").mCustomScrollbar()})}(jQuery),$("#foot").load("public.html"),$(function(){publicHeadfun(),days(),$("#selectTime").val($(".threeday").attr("value")),$("#endTime").val(compareDate(1,0)),loadAllDeviceData();var e=$("#selectTime").datepicker({format:"yyyy-mm-dd"}).on("changeDate",function(t){if(t.date.valueOf()>a.date.valueOf()){var n=new Date(t.date);n.setDate(n.getDate()+1),a.setValue(n)}e.hide(),$("#endTime")[0].focus(),$("#slectFen button .txt").html("自定义")}).data("datepicker"),a=$("#endTime").datepicker({format:"yyyy-mm-dd"}).on("changeDate",function(t){$("#slectFen button .txt").html("自定义");var n=!0;checkEndTime("selectTime","endTime",1)||($("#endTime").val(""),n=!1,layer.msg("结束时间需晚于开始时间")),compareYear(e.date,10)<=t.date.toLocaleDateString()&&(layer.msg("超过统计时间限制"),n=!1,$("#endTime").val("")),a.hide(),n&&(starts_time=$("#selectTime").val(),ends_time=$("#endTime").val(),createStockChart(tagsidforlist,starts_time,ends_time),layer.msg("选择的时间:"+starts_time+ends_time))}).data("datepicker");$("#every").click(function(){$("#quChart").is(":visible")?($("#quChart").hide(),$("#quChart1").show(),$("#every").html("历史趋势"),$(".choosetime").css("visibility","hidden")):($("#quChart").show(),$("#quChart1").hide(),$("#every").html("实时趋势"),$(".choosetime").css("visibility","visible"))})}),$("#wraplist").on("click","li a",function(){"close"==$(this).data("status")&&($(".list-a-click").removeClass("active"),$(this).addClass("active"),$(".list-a-click").data("status","close"),$(this).data("status","open"),$(".sub-views").hide(100),$($(this).data("target")).show(100))}),$("#main-menu-wrapper").on("click","ul.sub-views li a",function(e){$("#main-menu-wrapper ul.sub-views li a").removeClass("active"),$(this).addClass("active");var a=$(this).data("viewid");$("#EquipmentMonitoring a").tab("show"),restart&&(unsubscribeView(),mqtt.disconnect(),restart=!1),view_id=String(a),MQTTconnect(),setTimeout(function(){showCanvas(Number(a),imageCanvas)},100)});var allComponent={};$("#SecCanvasFullBtn").on("click","button",function(){if(Number(1===$(this).data("tag-type")))if("false"===String($(this).data("readonly"))&&"false"===String($(this).data("tagreadonly")))if(0===Number($(this).data("value"))){var e={tag_id:componentIsReadonly[$(this).data("id")].tag_id,value:String(1)},a=e;changeTagValue("global_btn",a,componentIsReadonly[$(this).data("id")].tag_id,componentIsReadonly[$(this).data("id")].id)}else if(1===Number($(this).data("value"))){var t={tag_id:componentIsReadonly[$(this).data("id")].tag_id,value:String(0)},a=t;changeTagValue("global_btn",a,componentIsReadonly[$(this).data("id")].tag_id,componentIsReadonly[$(this).data("id")].id)}else layer.msg("未初始化按钮的状态");else layer.msg("只读");else layer.msg("未绑定任何数据标签或绑定标签非开关型")});var componentIsReadonly={},componentTagValue=[],starts_time="",ends_time="";$("#qu table tbody").on("click","tr td a.watch",function(){tagsidforlist=$(this).data("id"),detail($(this).data("name")),$("#quChart").show(),$("#quChart1").hide(),$("#every").html("实时趋势"),$(".choosetime").css("visibility","visible"),TagRealTimevalue.tag_id=tagsidforlist;var e=new Date;starts_time=new Date(+e-1728e5).format("yyyy-MM-dd"),ends_time=e.format("yyyy-MM-dd"),$("#selectTime").val(starts_time),$("#endTime").val(ends_time),$("#slectFen button .txt").html("最近三天"),createStockChart($(this).data("id"),starts_time,ends_time),getTagRealTimevalue($(this).data("id"),$(this).data("name")),tagIdForHighChar=Number($(this).data("id"))}),$("#qu table tbody").on("click","tr td a.doIt",function(){changeComponentState($(this).data("id"))});var tagsidforlist,tagValueForHighChar,tagIdForHighChar,tagValueSetInterval;setInterval(function(){tagValue=Math.random()},100);var TagRealTimevalue={tag_id:"",tag_value:""},layerType,imageCanvas;$(window).load(function(){draw2d.Configuration.factory.createConnection=function(e,a,t,n){return new HoverConnection(e,a)};var e=new draw2d.Canvas("canvas");imageCanvas=e;var a=e.paper.createFilter();a.createShadow(0,0,3,.3,"#000000"),a.element.setAttribute("x","-35%"),a.element.setAttribute("y","-35%"),e.on("figure:add",function(e,t){t.figure instanceof draw2d.Connection||t.figure.shape.filter(a)}),e.installEditPolicy(new draw2d.policy.canvas.SnapToGeometryEditPolicy({lineColor:"#35c99d"})),e.installEditPolicy(new draw2d.policy.canvas.SnapToInBetweenEditPolicy({lineColor:"#35c99d"})),e.installEditPolicy(new draw2d.policy.canvas.SnapToCenterEditPolicy({lineColor:"#35c99d"}))});var HoverConnection=draw2d.Connection.extend({init:function(e,a){var t=this;this._super({router:new draw2d.layout.connection.InteractiveManhattanConnectionRouter,radius:5,stroke:1.35,color:"#68C9FF"}),this.on("dragEnter",function(e,a){t.attr({outlineColor:"#68C9FF",outlineStroke:2,color:"#68C9FF"})}),this.on("dragLeave",function(e,a){t.attr({outlineColor:"#68C9FF",outlineStroke:0,color:"#68C9FF"})})},onDragEnter:function(e){return this}});$("#slectFen ul li a").click(function(){var e=$(this).text(),a=$(this).attr("rel");1==a||2==a?($("#selectTime").val($(this).attr("value")),$("#endTime").val($(this).attr("value"))):3!=a&&4!=a&&5!=a||($("#selectTime").val($(this).attr("value")),$("#endTime").val(compareDate(1,0))),$("#slectFen button .txt").html(e).attr("rel",a),starts_time=$("#selectTime").val(),ends_time=$("#endTime").val(),createStockChart(tagsidforlist,starts_time,ends_time)}),$(function(){showOrHideGlobalbtn()}),$(window).resize(function(){var e=Number($(window).width());e<1835&&($("#main-menu-wrapper").css("left","-380px"),$(".handle").removeClass("open")),e>1835&&($("#main-menu-wrapper").css("left","0px"),$(".handle").addClass("open")),showOrHideGlobalbtn()}),$(".handle").on("click",function(){var e=(document.getElementById("main-menu-wrapper"),$("#main-menu-wrapper"));0==e.offset().left?startmove(1,-380,-20):startmove(0,0,20)});var timer=null;$("#EquipmentMonitoring a").on("click",function(){setTimeout(function(){(new draw2d.io.json.Writer).marshal(imageCanvas,function(e){for(var a in e){var t=getCanvasNode(imageCanvas,e[a].id);if(t.userData.valueType)switch(t.userData.valueType){case"textValueComponent":t.setText(String(t.getText()));break;case"valueComponent":"LabelComponent"===t.userData.types?t.setText(String(t.getText())):t.label.setText(String(t.label.getText()))}}})},300)});
function SelectActive(e,a){1==a?($(".navbar-nav li").removeClass("active"),$(e).addClass("active")):2==a?($("#leftNames aside li").removeClass("active"),$(e).addClass("active"),check_tree(1,$(e).attr("ids"))):($("#bao_leftNames aside li").removeClass("active"),$(e).addClass("active"),check_tree(2,$(e).attr("ids")))}function showValue(e){$(".addTime").css("visibility","visible");var a=$("#selectTime").val(),t=$("#endTime").val();""!=a&&""!=t&&$("#selectType .txt").html("自定义").attr("rel",9)}function showObj(e){1==e?$("#tongji").is(":hidden")?$("#tongji").slideDown():$("#tongji").slideUp():$("#tongjis").is(":hidden")?$("#tongjis").slideDown():$("#tongjis").slideUp()}function All(){if($("#tab_border").is(":hidden"))layer.msg("报表为空");else{var e=document.getElementById("tab_border");$("#tab_border header").show(),e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),e.style.height="100%",e.style.width="100%"}}function exitFullscreen(){var e=document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen(),$("#tab_border header").hide()}function del(e){void 0===(1==e?$("#leftNames li.active").attr("ids"):$("#bao_leftNames li.active").attr("ids"))?1===e?layer.msg("未选择任何自定义图表"):layer.msg("未选择任何自定义报表"):layer.confirm('<h4 style="color:#fff">您确认要删除该项目？</h4><p><small style="color:#fff">删除后不可恢复</small></p>',{btn:["取消","删除"],area:["1000px"],shade:0,title:!1,move:!1,shift:2,skin:"layui-primary",closeBtn:0},function(e){layer.close(e)},function(a){1==e?(Del(e),layer.close(a)):2==e&&(Del(e),layer.close(a))})}function otherSave(e,a,t){$("#"+a).val(""),1==e?$("#fen_select button .txt").html():$("#bao_select button .txt").html(),layer.open({title:[""+t,"font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["1000px","240px"],content:$("#otherSave"),shift:2,move:!1,btn:["确定","取消"],yes:function(a,t){var s;if(RegeMatch($("#fieldName")))if(1==e){if(fileName_s("fieldName",1)){s="EnergyGraphConfig";var i=getdata();2===i?layer.msg("不允许重复时间段"):1===i?layer.msg("不允许保存重复的tag"):$.ajax({type:"post",url:apiurl+s+"",dataType:"json",data:getdata(),success:function(e){e.success?($("#leftNames aside").remove("aside"),leftList(1),$("#leftNames aside li").removeClass("active"),$('#leftNames aside li[ids="'+e.data.id+'"]').css("border-right","2px solid red"),layer.close(a),layer.msg("保存成功")):layer.alert(e.error_message,{title:["错误信息"],skin:"lay-alert",move:!1})}})}}else 2==e&&fileName_s("fieldName",2)&&(s="EnergyReportConfig",$.ajax({type:"post",url:apiurl+s,dataType:"json",data:reportData(),success:function(e){e.success?($("#bao_leftNames aside").remove("aside"),leftList(2),$("#bao_leftNames aside li").removeClass("active"),$('#bao_leftNames aside li[ids="'+e.data.id+'"]').css("border-right","2px solid red"),layer.close(a),layer.msg("保存成功")):layer.alert(e.error_message,{title:["错误信息"],skin:"lay-alert",move:!1})}}));else layer.msg("指定的组名称格式错误")},btn2:function(e,a){}})}function compares(){if(""!=$("#selectTime").val()&&""!=$("#endTime").val()){if(!checkEndTime("selectTime","endTime",1))return layer.msg("结束时间需晚于开始时间"),void $("#endTime").val("");var e=judgeCompare();$(".addTime div").show();layer.open({title:["对比历史数据","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-compare",area:["935px","auto"],content:$("#"+e),shift:2,btn:["确定","取消"],yes:function(a,t){switch(e){case"compare":var s=!1;$("#compare div.historyInputCom").each(function(e,a){var t=$(a).find("input");if(t&&(""==$(t[0]).val()||""==$(t[1]).val()))return s=!0,!1}),s?layer.msg("对比历史时间段不能为空"):(loadHighcharData("screening","screening","screening",e),layer.close(a));break;case"compare1":loadHighcharData("screening","screening","screening",e),layer.close(a)}},btn2:function(e,a){layer.close(e)}})}else layer.msg("时间不能为空")}function judgeCompare(){var e;return 9==$("#selectType .txt").attr("rel")?(e="compare",$("#zi_start").html($("#selectTime").val()),$("#zi_end").html($("#endTime").val())):(e="compare1",$("#time_txt").html($("#slectFen .txt").html()),$("#time_start").html($("#selectTime").val()),$("#time_end").html($("#endTime").val())),e}function dickey(e){for(var a in e)return a}function loadHighcharData(screening,id,tag_taggroup,com){var statistic_type=$(".getshi a.active").attr("id"),charname=$(".getpic a.active").attr("id"),chardatetype=statistic_type,graph_type="1";"pie"==charname&&(graph_type="2");var tagId=null,tagType=null,history=[],lent=0,onedic={};switch(screening){case"screening":$.each($("#tree input[class*='skin-square-green']:checked"),function(e,a){tagId=$(this).attr("ids"),tagType=3==$(this).attr("id").split("-").length?2:1});break;case"select":tagId=id,tagType=tag_taggroup}if(null!=tagId){switch(com){case"compare":var firstTime={start_time:$("#selectTime").val(),end_time:$("#endTime").val()+" 23:59:59"};history.push(firstTime),$("#compare div.historyInputCom").each(function(e,a){var t=$(a).find("input");if(t&&""!=$(t[0]).val()&&""!=$(t[1]).val()){var s={start_time:$(t[0]).val(),end_time:$(t[1]).val()+" 23:59:59"};history.push(s),lent+=1,onedic[$(t[0]).val()]=$(t[1]).val()}});break;case"compare1":var firstTime={start_time:$("#selectTime").val(),end_time:$("#endTime").val()+" 23:59:59"};history.push(firstTime),$("#compare1 div.historyInputCom1").each(function(e,a){var t=$(a).find("span.historyCom1Span");if(t){var s={start_time:$(t[0]).text(),end_time:$(t[1]).text()+" 23:59:59"};history.push(s),lent+=1,onedic[$(t[0]).text()]=$(t[0]).text()}})}var jsonlength=0;for(var jskey in onedic)jsonlength+=1;if(jsonlength===lent){var datas={graph_type:graph_type,statistics_type:statistic_type,history:history,id_type:tagType,id:tagId},_r="HistoryDataTimesContrast",colors=["#A4CD52","#E7706F","#9B77B3","#4CB3E3","#9B77B3","#477B36","#EABE43","#135083","#8B6527","#B3CE59","#E8767B","#9980AF","#5CB1E1","#A977AB","#427A46","#D7AA5E","#3B507B","#3B507B","#996725","#C0D060","#EA7D86","#9789AA","#67AEDE","#B576A2","#3C7856","#C2956F","#594F73","#A66922","#CDD065","#EC8392","#9491A3","#71ABDB","#C07698","#347667","#AF817C","#714F6A","#B46B1F","#D9D06D","#ED8A9F","#91989A","#7AA7D7","#CA758E","#2D7477","#9C6D84","#864E61","#C06C1C","#E4CF73","#EE91AB","#8D9E90","#83A4D4","#D57484","#237286","#895989","#9A4C59","#CC6E19","#EECE79","#F098B7","#89A584","#8BA0D1","#DE717A","#1D7095","#75468E","#AC494F","#D86F14","#F7CC7F","#FFA2CB","#85AB77","#919BCD","#E7706F","#E7706F","#1A6DA3","#62328F","#62328F","#BC4746","#E47113"];$.ajax({type:"put",url:apiurl+_r,dataType:"json",data:datas,beforeSend:function(){$(".loading").show()},success:function(result){if($(".loading").hide(),isHistoryData=!0,"pie"==charname)if(result.success){var seriesdata="[";if(result.success){var j=0;for(var keypie in result.data){var values=result.data[keypie];Number(values)<0&&(values=0),seriesdata+='{name:"'+keypie+'",y:'+values+',color:"'+colors[j]+'"},',j++}seriesdata=seriesdata.substring(0,seriesdata.length-1),seriesdata+="]"}}else seriesdata="[无能耗数据]";else if(result.success){var mainKey=dickey(result.data),returndata="[",areadata="[",i=0;for(var key in result.data){returndata+="{name:'"+result.data[key].name+"',marker:{enabled:true,radius:3},color:'"+colors[i]+"',data:[",areadata+="{name:'"+result.data[key].name+"',color:'"+colors[i]+"',data:[";var datename="";if(isEmptyObject(result.data[key].values))returndata+="]",areadata+="]";else{var data_key_values=result.data[key].values;for(var keys in data_key_values){switch(chardatetype){case"hour":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/"+keys.substring(6,8)+" "+keys.substring(8,10)+":00:00";break;case"day":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/"+keys.substring(6,8)+" 00:00:00";break;case"month":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/01 00:00:00";break;case"year":datename=keys.substring(0,4)+"/01/01 00:00:00"}var datestr=new Date(datename);datestr=datestr.getTime()+288e5,returndata+="["+datestr+","+data_key_values[keys]+"],",areadata+="["+datestr+","+data_key_values[keys]+"],"}}returndata=returndata.substring(0,returndata.length-1)+"]},",areadata=areadata.substring(0,areadata.length-1)+"]},",i++}returndata=returndata.substring(0,returndata.length-1)+"]",areadata=areadata.substring(0,areadata.length-1)+"]";var mainKey=dickey(result.data),textReturndata=eval("("+returndata+")"),textAreadata=eval("("+areadata+")");for(var dic in textReturndata)if(textReturndata[dic].name==mainKey)for(var dics in textReturndata)for(var dicss in textReturndata[dics].data)textReturndata[dic].data[dicss]&&(textReturndata[dics].data[dicss][0]=textReturndata[dic].data[dicss][0]);for(var dic in textAreadata)if(textAreadata[dic].name==mainKey)for(var dics in textAreadata)for(var dicss in textAreadata[dics].data)textAreadata[dic].data[dicss]&&(textAreadata[dics].data[dicss][0]=textAreadata[dic].data[dicss][0])}else returndata="[无能耗数据]",areadata="[无能耗数据]";"column"==charname||"spline"==charname?$("#lineCharts").highcharts("StockChart",{chart:{backgroundColor:"#1C203F",alignTicks:!0,type:""+charname},tooltip:{type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"},shared:!0},rangeSelector:{allButtonsEnabled:!0,enabled:!1,buttonTheme:{width:60},selected:2},navigator:{enabled:!0,xAxis:{labels:{style:{color:"#fff"}},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H点",day:"%Y年%m月%d日",week:"%e. %b",month:"%Y年%m月",year:"%Y年"}}},title:{text:""},legend:{symbolHeight:12,symbolWidth:18,symbolRadius:0,itemStyle:{color:"#ffffff"},layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!0,labelFormatter:function(){var e;return e='<a title="'+this.name+'">',this.name.length>10?(e+=this.name.substring(0,5),e+="...",e+=this.name.substring(this.name.length-5,this.name.length)):e+=this.name,e+="</a>"}},exporting:{enabled:!1},credits:{enabled:!1},xAxis:{labels:{style:{color:"#ffffff"}},lineColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"}},yAxis:{labels:{style:{color:"#ffffff"}},gridLineColor:"#555769",opposite:!1,title:{style:{color:"#ffffff"},text:"耗电量(kWh)"}},series:"[无能耗数据]"==returndata?null:textReturndata}):"pie"==charname?$("#lineCharts").highcharts({chart:{backgroundColor:"#1C203F",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},tooltip:{pointFormat:"{series.name} : <b>{point.percentage:.1f}% ({point.y})</b>"},credits:{enabled:!1},exporting:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"#fff",fontWeight:"bold",textOutline:"none"}}}},series:[{type:"pie",name:"占比",data:"[无能耗数据]"==seriesdata?null:eval("("+seriesdata+")")}]}):"area"==charname&&$("#lineCharts").highcharts("StockChart",{chart:{backgroundColor:"#1C203F",type:"column"},tooltip:{xDateFormat:"%Y-%m-%d %H:%M:%S",shared:!0},rangeSelector:{allButtonsEnabled:!0,enabled:!1,buttonTheme:{width:60},selected:2},navigator:{enabled:!0,xAxis:{labels:{style:{color:"#fff"}},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H点",day:"%Y年%m月%d日",week:"%e. %b",month:"%Y年%m月",year:"%Y年"}}},title:{text:""},legend:{symbolHeight:12,symbolWidth:18,symbolRadius:0,itemStyle:{color:"#ffffff"},layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!0,labelFormatter:function(){var e;return e='<a title="'+this.name+'">',this.name.length>10?(e+=this.name.substring(0,5),e+="...",e+=this.name.substring(this.name.length-5,this.name.length)):e+=this.name,e+="</a>"}},exporting:{enabled:!1},credits:{enabled:!1},xAxis:{labels:{style:{color:"#ffffff"}},lineColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"}},yAxis:{labels:{style:{color:"#ffffff"}},gridLineColor:"#555769",opposite:!1,title:{style:{color:"#ffffff"},text:"耗电量(kWh)"}},plotOptions:{column:{stacking:"normal"}},series:"[无能耗数据]"==areadata?null:textAreadata})},complete:function(){$(".loading").hide()},error:function(e){publicAjaxError(e)}})}else layer.msg("时间段不能重复")}}function bindListener(e){$("div[id^=timeDiv] .img").unbind().click(function(){i-=2,$(this).parent().remove(),$("#"+e).parent().height($("#"+e).parent().height()-45)})}function selectDrown(e,a){$(".downselect .dropList"+e+" li a").one("click",function(){var t=$(this).text(),s=$(this).attr("rel");initAddreletiveAdd(a,e,s),$(".downselect #days"+e+" .txt").html(t).attr("rel",s),$(".downselect .dropList"+e+" li a").unbind("click")})}function initTime(){$("#selectTime").val(compareDate(1,6)),$("#endTime").val(compareDate(1,0)),$("#bao_day").val(getToday()),$("#bao_month").val(getMonth()),$("#bao_year").val(getYear())}function initAddreletiveAdd(e,a,t){var s=1,i=0;t&&(s=Number(t)),e=Number(e),1==e||2==e?1==e?($("#tians_"+a).html(compareDate(1,s)),$("#tiane_"+a).html(compareDate(1,s))):($("#tians_"+a).html(compareDate(1,s+1)),$("#tiane_"+a).html(compareDate(1,s+1))):3==e||4==e||5==e?(3==e?i=3:4==e?i=7:5==e&&(i=30),$("#tians_"+a).html(compareDate(1,i*s+i-1)),$("#tiane_"+a).html(compareDate(1,i*s))):6!=e&&7!=e&&8!=e||(i=1,6==e?($("#tians_"+a).html(getCurrentMonthFirst(i*s+1)),$("#tiane_"+a).html(getCurrentMonthLastForSelect(compareDate(3,i*s+1)))):7==e?($("#tians_"+a).html(getCurrentMonthFirst(i*s+2)),$("#tiane_"+a).html(getCurrentMonthLastForSelect(compareDate(3,i*s+2)))):8==e&&($("#tians_"+a).html(getCurrentMonthFirst(i*s+3)),$("#tiane_"+a).html(getCurrentMonthLastForSelect(compareDate(3,i*s+3)))))}function initAdd(e,a,t){var s=1,i=0;t&&(s=Number(t)),e=Number(e),1==e||2==e?1==e?($("#tians_"+a).html(compareDate(1,s)),$("#tiane_"+a).html(compareDate(1,s))):($("#tians_"+a).html(compareDate(1,s+1)),$("#tiane_"+a).html(compareDate(1,s+1))):3==e||4==e||5==e?(3==e?i=3:4==e?i=7:5==e&&(i=30),$("#tians_"+a).html(compareDate(1,i*s+i)),$("#tiane_"+a).html(compareDate(1,i*s+1))):6!=e&&7!=e&&8!=e||(i=1,$("#tians_"+a).html(getCurrentMonthFirst(i*s+1)),$("#tiane_"+a).html(getCurrentMonthLast(compareDate(2,i*s+1))))}function checkTimeforZidingyiHistory(e,a){var t=checkEndTime($("#zi_start").html(),$("#zi_end").html(),2),s=$("#start"+a).val();$("#end"+a).val();$("#start"+a).datepicker().on("changeDate",function(e){s=$("#start"+a).val(),$("#end"+a).val(FormatDate(CutDays(parseDate(s),t,1),"yyyy-MM-dd"));checkEndTime("start"+a,"end"+a,1)})}function checkTime(e,a){var t=checkEndTime($("#zi_start").html(),$("#zi_end").html(),2),s=$("#start"+a).val(),i=$("#end"+a).val();""!=i&&1==e?$("#start"+a).datepicker().on("changeDate",function(e){s=$("#start"+a).val(),$("#end"+a).val(FormatDate(CutDays(parseDate(s),t,1),"yyyy-MM-dd")),checkEndTime("start"+a,"end"+a,1)||(layer.msg("结束时间需晚于开始时间"),$("#end"+a).val("")),checkEndTime(s,$("#end"+a).val(),2)!=t&&(layer.msg("步长不一致"),$("#end"+a).val(""))}):$("#end"+a).datepicker().on("changeDate",function(e){i=$("#end"+a).val(),$("#start"+a).val(FormatDate(CutDays(parseDate(i),t),"yyyy-MM-dd"));var r=new Date($("#start"+a).val().replace("-","/").replace("-","/"));s=$("#start"+a).val(),checkEndTime("start"+a,"end"+a,1)||(layer.msg("结束时间需晚于开始时间"),$("#end"+a).val("")),compareYear(r,10)<=e.date.toLocaleDateString()&&($("#end"+a).val(""),layer.msg("超过统计时间限制")),checkEndTime(s,i,2)!=t&&(layer.msg("步长不一致"),$("#end"+a).val(""))})}function formatDate(e){var a=e.substring(0,4)+"-";return a+=e.substring(4,6)+"-",a+=e.substring(6,8)}function checkTree(e,a){var t=new Array,s="",i=$("#"+e+" input[class*='skin-square-green']:checked").length;return a||($(".getpic a").removeClass("active").addClass("hide"),0==i?($(".getpic a").removeClass("hide"),$("#history").removeClass("btnborder_disabled").removeAttr("disabled")):1==i?($(".getpic a").removeClass("hide"),$("#history").removeClass("btnborder_disabled").removeAttr("disabled")):($("#history").addClass("btnborder_disabled").attr("disabled","disabled"),i<=16&&$(".getpic a").removeClass("hide"),i>16&&$(".getpic a").removeClass("hide"))),i>64&&$("#"+e+" .icheckbox_square-green']").on("ifUnchecked",function(a){$("#"+e+" input[class*='skin-square-green']").iCheck("uncheck")}),$.each($("#"+e+" input[class*='skin-square-green']:checked"),function(e,a){s+=$(this).attr("id")+","}),t[0]=i,t[1]=s,t}function clearSelection(e){$("#"+e+" label").each(function(){$(this).find(".highlight").each(function(){$(this).replaceWith($(this).html())})})}function highlight(e,a){$("#"+a+" .f1 div[class*='in']").removeClass("in"),clearSelection(a);var t=$("#"+e).val(),s=new RegExp(t,"g"),i=$("#"+a+" label").text();if(!s.test(i))return void layer.msg("没有找到符合你条件的数据！");$("#"+a+" label").each(function(){var e=$(this).html(),a=e.replace(s,'<span class="highlight">'+t+"</span>");if(-1!=a.indexOf("highlight"))if($(this).parents("h4").hasClass("panel-title")){var i=$(this).parents("h4 a").attr("href");$(""+i).addClass("in").css("height","")}else{var r=$(this).parents(".panel-collapse").attr("id");$("#"+r).addClass("in").css("height","")}$(this).html(a)})}function leftList(e){var a="";1==e?a="EnergyGraphConfig":2==e&&(a="EnergyReportConfig"),$.ajax({type:"GET",url:apiurl+a,success:function(a){if(a.success)if(null===a.data.items){var t=1==e?"自定义图表":"自定义报表",s=1==e?2:3,i='<aside class="aside"><h4>'+t+"</h4><hr/><ul>";i+="无数据",i+="</ul></aside>"}else{var t=1==e?"自定义图表":"自定义报表",s=1==e?2:3,i='<aside class="aside"><h4>'+t+"</h4><hr/><ul>";$.each(a.data.items,function(e,a){i+='<li onclick="SelectActive(this,'+s+')" ids="'+a.id+'" ><span><a style="font-size:14px;">'+a.name+"</a></span></li>"}),i+="</ul></aside>"}else{var t=1==e?"自定义图表":"自定义报表",s=1==e?2:3,i='<aside class="aside"><h4>'+t+"</h4><hr/><ul>";i+=a.error_message,i+="</ul></aside>"}var r=1==e?"leftNames":"bao_leftNames";$("#"+r+" .mCSB_container").append(i),$("#"+r).mCustomScrollbar({scrollButtons:{enable:!1}})},error:function(e){returnLogIn(e)}})}function clearCheck(e){1==e?($("#tree input").iCheck("uncheck"),clearSelection("tree"),$("#history").removeClass("btnborder_disabled").removeAttr("disabled")):($("#trees input").iCheck("uncheck"),clearSelection("trees"))}function getTree(e,a){$("#"+e).val()?highlight(e,a):layer.msg("请输入统计对象名称")}function rightTree(e){$.ajax({type:"GET",url:apiurl+"project",success:function(a){$(".loading").show(),a.success?$.ajax({type:"GET",url:apiurl+"EnergyConfigClassification/0",complete:function(){$(".loading").hide()},success:function(t){if($(".loading").hide(),null!==t.data.items){var s="";t.success&&(s+='<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title"><a href="#'+e+"-"+a.data.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle" aria-expanded="true  pointGroups-name">'+a.data.name+"</a></h4></div>",s+='<div class="panel-collapse collapse in" id="'+e+"-"+a.data.id+'" aria-expanded="false" ><div class="panel-body">',$.each(t.data.items,function(a,t){var i,r,l;if(r=!t.hide_tag,l=!!t.next_level,i=!1===l&&!1===r?"":"add",s+='<div class="panel panel-default"><div class="panel-heading fang" style="padding-left:0;padding-right:0px;" ><h4 class="panel-title">',s+=""===i?'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion"  class="one-step accordion-toggle  '+i+' pointGroups-a" aria-expanded="true">':'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion" data-toggle="collapse" class="one-step accordion-toggle  '+i+' pointGroups-a" aria-expanded="false">',s+='<input  type="checkbox" id="'+e+"-"+t.id+"-"+a+'"  class="bayaxcheckbox fu" ids="'+t.id+'" ><label class="checkbox-i" for="'+e+"-"+t.id+"-"+a+'"></label> <label  class="form-label pointGroups-label">'+t.name+"</label></a></h4></div></div>",s+='<div class="panel-collapse collapse in" id="'+e+"-s"+t.id+'" aria-expanded="true">',t.next_level&&$.each(t.next_level,function(a,t){var i,r,l;if(r=!t.hide_tag,l=!!t.next_level,i=!1===l&&!1===r?"":"add",s+='<div class="panel panel-default" ><div class="panel-heading fang" style="margin-left: 23px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+=""===i?'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion"  class="accordion-toggle collapsed '+i+' pointGroups-a" aria-expanded="false">':'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+i+' pointGroups-a" aria-expanded="false">',s+='<input tabindex="5" type="checkbox" id="'+e+"-"+t.id+"-"+a+'"  class="skin-square-green fu" ids="'+t.id+'" ><label  class="form-label pointGroups-label">'+t.name+"</label></a></h4></div></div>",s+='<div class="panel-collapse collapse " id="'+e+"-s"+t.id+'" aria-expanded="false" style="height: 0px;">',t.next_level&&$.each(t.next_level,function(a,t){var i,r,l;if(r=!t.hide_tag,l=!!t.next_level,i=!1===l&&!1===r?"":"add",s+='<div class="panel panel-default" style="padding-left:30px;"><div class="panel-heading fang" style="padding-left:45px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+=""===i?'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion"  class="accordion-toggle collapsed '+i+' pointGroups-a" aria-expanded="false">':'<a  href="#'+e+"-s"+t.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+i+' pointGroups-a" aria-expanded="false">',s+='<input tabindex="5" type="checkbox" id="'+e+"-"+t.id+"-"+a+'"  class="skin-square-green fu" ids="'+t.id+'" ><label  class="form-label pointGroups-label">'+t.name+"</label></a></h4></div></div>",s+='<div class="panel-collapse collapse " id="'+e+"-s"+t.id+'" aria-expanded="false" style="height: 0px;padding-left:45px;">',0===t.hide_tag);else{var n=t.tag_list;null!==n&&$.each(n,function(i,r){s+='<div class="panel-body tree-msg" style="padding-left:40px;padding-top:5px;padding-bottom:5px;"><a href="#'+e+"-"+r.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed pointGroups-a-son" aria-expanded="false"><input tabindex="5" oprate="'+r.oprate+'" type="checkbox" id="'+e+"-"+t.id+"-"+a+"-"+i+'" class="skin-square-green" ids="'+r.tag_id+'" ><label class="form-label pointGroups-label-son">'+r.name+"</label></a></div>"})}s+="</div>"}),0===t.next_level.length)if(0===t.hide_tag);else{var n=t.tag_list;null!==n&&$.each(n,function(i,r){s+='<div class="panel-body tree-msg" style="padding-left:53px;;padding-top:5px;padding-bottom:5px;"><a href="#'+e+"-"+r.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed pointGroups-a-son" aria-expanded="false"><input tabindex="5" oprate="'+r.oprate+'" type="checkbox" id="'+e+"-"+t.id+"-"+a+"-"+i+'" class="skin-square-green" ids="'+r.tag_id+'" ><label class="form-label pointGroups-label-son">'+r.name+"</label></a></div>"})}s+="</div>"}),0===t.next_level.length)if(0===t.hide_tag);else{var n=t.tag_list;null!==n&&$.each(n,function(i,r){s+='<div class="panel-body tree-msg" style=";margin-left: 25px;padding-top:5px;padding-bottom:5px;"><a href="#'+e+"-"+r.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed pointGroups-a-son" aria-expanded="false"><input tabindex="5" oprate="'+r.oprate+'" type="checkbox" id="'+e+"-"+t.id+"-"+a+"-"+i+'" class="skin-square-green" ids="'+r.tag_id+'" ><label class="form-label pointGroups-label-son">'+r.name+"</label></a></div>"})}s+="</div>"}),s+="</div></div></div>",$("#"+e+" .mCSB_container").append(s),$("#"+e).mCustomScrollbar("scrollTo"))}}}):html=result.error_message},error:function(e){publicAjaxError(e)}})}function SelectData(e){if(1==e){$("#compare .addTime").html(""),$("#compare1 .addTime").html(""),$(".getpic a").removeClass("active");var a=checkTree("tree"),t=a[0],s=a[1];if(0==t){$("#lineCharts").html("");$("#lineCharts").append('<span id="sTitle" class="sTitle">统计对象为空</span>')}t>0&&t<=16?($(".getpic a:eq(0)").addClass("active"),isHistoryData=!1,bindCharts(t,s)):0!=t&&layer.msg("请选择不超过16条统计对象进行对比"),$(".tongji").hide()}else BaoTableList()}function SelectDataHistory(e,a,t,s){if(1==e){$(".getpic a").removeClass("active");var i=checkTree("tree"),r=i[0];i[1];r>0&&r<=16&&($(".getpic a:eq(0)").addClass("active"),loadHighcharData("select",a,t,s)),$(".tongji").hide()}else BaoTableList()}function Del(e){var a,t=1==e?$("#leftNames li.active").attr("ids"):$("#bao_leftNames li.active").attr("ids");a=1==e?"EnergyGraphConfig/":"EnergyReportConfig/",$.ajax({url:apiurl+a+t,type:"DELETE",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){if($(".loading").hide(),a.success){if(1==e){$("#leftNames aside").remove("aside"),leftList(1),$("#leftNames aside li").removeClass("active"),$("#lineCharts").highcharts().destroy(),$("#lineCharts").html("");$("#lineCharts").append('<span id="sTitle" class="sTitle">请选择统计对象生成图表</span>');var t=1==e?"tree":"trees";$("#"+t+" input[class*='skin-square-green']").iCheck("uncheck")}else{$("#bao_leftNames aside").remove("aside"),leftList(2),$("#bao_leftNames aside li").removeClass("active"),$("#noloud span.kong").text("请选择统计对象生成报表"),$("#noloud").show(),$("#tab_border").hide();var t=1==e?"tree":"trees";$("#"+t+" input[class*='skin-square-green']").iCheck("uncheck")}layer.msg("删除成功")}else layer.msg("请选择要删除的图表")},error:function(e){publicAjaxError(e)}})}function Objfu(e,a,t){this.id=e,this.selected=a,this.tags=t}function Objzi(e,a){this.id=e,this.oprate=a}function Dictionary(){this.data=new Array,this.put=function(e,a){this.data[e]=a}}function getdata(e){var a,t,s="none",i=null,r=null,l="[]",n="[]",o=[],d=!0;if(9!=$("#slectFen button .txt").attr("rel")){a=1;switch(Number($("#slectFen button .txt").attr("rel"))){case 1:s="day",t=0;break;case 2:s="day",t=-1;break;case 3:s="day",t=-3;break;case 4:s="day",t=-7;break;case 5:s="day",t=-30;break;case 6:s="month",t=-1;break;case 7:s="month",t=-2;break;case 8:s="month",t=-3}if(checkTree("tree",1)[0]<=1){var c={};l="[";for(var h=$("#compare1 .addTime div").length,m=1;m<h+1;m++){var p=$("#compare1 .addTime #days"+m+" .txt").attr("rel");l+='{"day":-'+$("#compare1 .addTime #days"+m+" .txt").attr("rel")+"}",m!=h&&(l+=","),c[p]=p}l+="]";var u=0;for(var g in c)u+=1;u!==h&&(d=!1)}}else if(a=2,i=$("#selectTime").val(),r=$("#endTime").val(),checkTree("tree",1)[0]<=1){var c={},h=$("#compare .addTime div").length;n="[";for(var m=1;m<=h;m++){var f=$("#start"+m).val(),v=$("#end"+m).val();""!=f&&""!=v&&(f=f.replace(new RegExp(/(-)/g),""),v=v.replace(new RegExp(/(-)/g),""),n+='{"start":'+f+',"end":'+v+"}",c[f]=f,m!=h&&(n+=","))}n+="]";var u=0;for(var g in c)u+=1;u!==JSON.parse(n).length&&(d=!1)}if($.each($("#tree input[class*='skin-square-green']:checked"),function(e,a){if($(this).hasClass("fu")){var t=$(this).attr("id").split("-");$(this).parent().next().html();o.push(new Objfu($(this).attr("ids"),1,null))}else{var s=$(this).attr("id").split("-"),i=s[1],r=0;if(o.length>0){var l=$(this).attr("ids"),n=($(this).parent().next().html(),$(this).attr("oprate")),d=[];$.each(o,function(e,a){if(a.id==i)return r=1,null==o[e].tags?(d.push(new Objzi(l,n)),o[e].tags=d):o[e].tags.push(new Objzi(l,n)),!1})}if(0==r){var d=[],t=$(this).attr("id").split("-");$("#tree input[class~='fu'][id*='"+t[0]+"-"+t[1]+"']").parent().next().html();d.push(new Objzi($(this).attr("ids"),$(this).attr("oprate"))),o.push(new Objfu(t[1],0,d))}}}),e){var y=$("#leftNames aside li.active").attr("ids"),b=$("#leftNames aside li.active a").html();datas={id:y,name:b,date_type:a,length_unit:s,lengths:t,start_time:i,end_time:r,relative_history:l,absolute_history:n,tag_id_tree:JSON.stringify(o)}}else{var b=$("#fieldName").val();datas={name:b,date_type:a,length_unit:s,lengths:t,start_time:i,end_time:r,relative_history:l,absolute_history:n,tag_id_tree:JSON.stringify(o)}}for(var C={},k=[],x=[],m=0;m<o.length;m++){var _=o[m].tags;if(null!==_)for(var g=0;g<_.length;g++)C[_[g].id]=_[g].id,k.push(_[g].id)}for(var T in C)x.push(T);return x.length!==k.length?1:d?datas:2}function save(e){var a;if(1==e)if($("#leftNames aside li").hasClass("active")){a="EnergyGraphConfig";var t=getdata(1);2===t?layer.msg("不允许重复时间段"):1===t?layer.msg("不允许保存重复的tag"):$.ajax({type:"PUT",url:apiurl+a,dataType:"json",data:t,success:function(e){e.success?layer.msg("更新成功"):layer.alert(e.error_message,{title:["错误信息"],skin:"lay-alert",move:!1})}})}else otherSave(1,"fieldName","保存");else if($("#bao_leftNames aside li").hasClass("active")){var s=!1;a="EnergyReportConfig",s||($.ajax({type:"PUT",url:apiurl+a,dataType:"json",data:reportData(1),success:function(e){e.success?layer.msg("更新成功"):layer.alert(e.error_message,{title:["错误信息"],skin:"lay-alert",move:!1})}}),s=!0)}else otherSave(2,"fieldName","保存")}function reportData(e){var a,t,s,i,r,l=[];switch(Number($("#selectBao button .txt").attr("rel"))){case 1:a="day",i=$("#bao_day").val();break;case 2:a="month",i=$("#bao_month").val();break;case 3:a="year",i=$("#bao_year").val()+"-01"}return $.each($("#trees input[class*='skin-square-green']:checked"),function(e,a){if($(this).hasClass("fu")){var t=$(this).attr("id").split("-");$(this).parent().next().html();l.push(new Objfu($(this).attr("ids"),1,null))}else{var s=$(this).attr("id").split("-"),i=s[1],r=0;if(l.length>0){var n=$(this).attr("ids"),o=($(this).parent().next().html(),$(this).attr("oprate")),d=[];$.each(l,function(e,a){if(a.id==i)return r=1,null==l[e].tags?(d.push(new Objzi(n,o)),l[e].tags=d):l[e].tags.push(new Objzi(n,o)),!1})}if(0==r){var d=[],t=$(this).attr("id").split("-");$("#tree input[class~='fu'][id*='"+t[0]+"-"+t[1]+"']").parent().next().html();d.push(new Objzi($(this).attr("ids"),$(this).attr("oprate"))),l.push(new Objfu(t[1],0,d))}}}),e?(t=$("#bao_leftNames aside li.active").attr("ids"),s=$("#bao_leftNames aside li.active a").html(),r={id:t,name:s,statistics_type:a,date:i,tag_id_tree:JSON.stringify(l)}):(s=$("#fieldName").val(),r={name:s,statistics_type:a,date:i,tag_id_tree:JSON.stringify(l)}),r}function check_tree(e,a){$(".loading").show(),$(".addTime").html("");var t;t=1==e?"EnergyGraphConfig/":"EnergyReportConfig/",$.ajax({type:"GET",url:apiurl+t+a,success:function(a){$(".loading").hide();var t=1==e?"tree":"trees";if(a.success)if($("#"+t+" input[class*='skin-square-green']").iCheck("uncheck"),null!==a.data.tag_id_tree&&$.each(JSON.parse(a.data.tag_id_tree),function(e,a){1==a.selected&&$("a[href='#"+t+"-s"+a.id+"']").find(".skin-square-green").iCheck("check"),a.tags&&($("#"+t+"-s"+a.id).addClass("in").css("height",""),$.each(a.tags,function(e,s){$("#"+t+"-s"+a.id).find("input[ids='"+s.id+"']").iCheck("check")}))}),1==e){if(1==a.data.date_type){var s=a.data.lengths;switch($(".getshi a").removeClass("active").addClass("hide"),a.data.length_unit){case"day":0==s?($("#slectFen button .txt").html("今天").attr("rel","1"),$("#selectTime").val(FormatDate(new Date,"yyyy-MM-dd")),$("#endTime").val(FormatDate(new Date,"yyyy-MM-dd")),$(".getshi a:eq(0)").removeClass("hide").addClass("active")):-1==s?($("#slectFen button .txt").html("昨天").attr("rel","2"),$("#selectTime").val(compareDate(1,1)),$("#endTime").val(compareDate(1,1)),$(".getshi a:eq(0)").removeClass("hide").addClass("active")):-3==s?($("#slectFen button .txt").html("最近3天").attr("rel","3"),$("#selectTime").val(compareDate(1,2)),$("#endTime").val(compareDate(1,0)),$(".getshi a:eq(0)").removeClass("hide").addClass("active"),$(".getshi a:eq(1)").removeClass("hide")):-7==s?($("#slectFen button .txt").html("最近7天").attr("rel","4"),$("#selectTime").val(compareDate(1,6)),$("#endTime").val(compareDate(1,0)),$(".getshi a:eq(0)").removeClass("hide").addClass("active"),
$(".getshi a:eq(1)").removeClass("hide")):-30==s&&($("#slectFen button .txt").html("最近30天").attr("rel","5"),$("#selectTime").val(compareDate(1,29)),$("#endTime").val(compareDate(1,0)),$(".getshi a:eq(1)").removeClass("hide").addClass("active"));break;case"month":if(-1==s){$("#slectFen button .txt").html(compareDate(2,1)+"月").attr("rel","6");var i=new Date,r=Number(i.getMonth()+1);1===r?$("#selectTime").val(i.getFullYear()-1+"-"+compareDate(2,1)+"-01"):$("#selectTime").val(i.getFullYear()+"-"+compareDate(2,1)+"-01");compareDate(2,1);$("#endTime").val(getCurrentMonthLastForSelect($("#selectTime").val())),$(".getshi a:eq(1)").removeClass("hide").addClass("active"),$(".getshi a:eq(2)").removeClass("hide")}else if(-2==s){var i=new Date,r=Number(i.getMonth()+1);1===r||2===r?$("#selectTime").val(i.getFullYear()-1+"-"+compareDate(2,2)+"-01"):$("#selectTime").val(i.getFullYear()+"-"+compareDate(2,2)+"-01"),$("#slectFen button .txt").html(compareDate(2,2)+"月").attr("rel","7");compareDate(2,2);$("#endTime").val(getCurrentMonthLastForSelect($("#selectTime").val())),$(".getshi a:eq(1)").removeClass("hide").addClass("active"),$(".getshi a:eq(2)").removeClass("hide")}else if(-3==s){var i=new Date,r=Number(i.getMonth()+1);1===r||2===r||3===r?$("#selectTime").val(i.getFullYear()-1+"-"+compareDate(2,3)+"-01"):$("#selectTime").val(i.getFullYear()+"-"+compareDate(2,3)+"-01"),$("#slectFen button .txt").html(compareDate(2,3)+"月").attr("rel","8");compareDate(2,3);$("#endTime").val(getCurrentMonthLastForSelect($("#selectTime").val())),$(".getshi a:eq(1)").removeClass("hide").addClass("active"),$(".getshi a:eq(2)").removeClass("hide")}}}else{$("#selectTime").val(a.data.start_time.substring(0,10)),$("#endTime").val(a.data.end_time.substring(0,10)),$("#slectFen button .txt").html("自定义").attr("rel","9");var l=$("#selectTime").val(),n=$("#endTime").val();if(""!=l&&""!=n){$(".getshi a").removeClass("active").addClass("hide");var o=checkEndTime(l,n,2);1==o||0==o?$(".getshi a:eq(0)").removeClass("hide").addClass("active"):o>1&&o<=7?($(".getshi a:eq(0)").removeClass("hide").addClass("active"),$(".getshi a:eq(1)").removeClass("hide")):o>7&&o<=30?$(".getshi a:eq(1)").removeClass("hide").addClass("active"):o>30&&o<=180?($(".getshi a:eq(1)").removeClass("hide").addClass("active"),$(".getshi a:eq(2)").removeClass("hide")):o>180&&o<=365?$(".getshi a:eq(2)").removeClass("hide").addClass("active"):($(".getshi a:eq(2)").removeClass("hide").addClass("active"),$(".getshi a:eq(3)").removeClass("hide"))}}var d=JSON.parse(a.data.absolute_history),c=JSON.parse(a.data.relative_history),h=JSON.parse(a.data.tag_id_tree);if(0!==d.length&&0===c.length&&getHistory(d,1,a.data.length_unit),0!==c.length&&0===d.length&&getHistory(c,2,a.data.length_unit),0!==d.length||0!==c.length)if(isHistoryData=!0,0===h.length){$("#lineCharts").html("");var m='<span id="sTitle" class="sTitle">统计对象为空</span>';$("#lineCharts").append(m)}else 0!==d.length?0==h[0].selected?SelectDataHistory(1,h[0].tags[0].id,1,"compare"):SelectDataHistory(1,h[0].id,2,"compare"):0==h[0].selected?SelectDataHistory(1,h[0].tags[0].id,1,"compare1"):SelectDataHistory(1,h[0].id,2,"compare1");else if(isHistoryData=!1,0==h.length){$("#lineCharts").html("");var m='<span id="sTitle" class="sTitle">统计对象为空</span>';$("#lineCharts").append(m)}else SelectData(1)}else{var p=a.data.statistics_type,u=a.data.date.substring(0,10),g=JSON.parse(a.data.tag_id_tree);switch($("#selectInput input").hide(),p){case"day":$("#selectTypes .txt").attr("rel"),$("#selectTypes .txt").html("日报").attr("rel","1"),$("#bao_day").val(u).show();break;case"month":$("#selectTypes .txt").attr("rel"),$("#selectTypes .txt").html("月报").attr("rel","2"),$("#bao_month").val(u.substring(0,7)).show();break;case"year":$("#selectTypes .txt").attr("rel"),$("#selectTypes .txt").html("年报").attr("rel","3"),$("#bao_year").val(u.substring(0,4)).show()}0!==g.length?BaoTableList():($("#noloud span.kong").text("统计对象为空"),$("#tab_border").hide(),$("#noloud").show())}},error:function(e){publicAjaxError(e)}})}function getHistory(e,a,t){var s=$("#selectType .txt").attr("rel"),r="";if(1!=s&&2!=s||(r="天"),3!=s&&4!=s&&5!=s||(r+="个",3==s?r+="3":4==s?r+="7":5==s&&(r+="30"),r+="天"),6!=s&&7!=s&&8!=s||(r="个月"),1==a){var s=$("#selectType .txt").attr("rel"),l="";i=e.length,$.each(e,function(e,a){var t=formatDate(String(a.start)),s=formatDate(String(a.end));l=$('<div class = "historyInputCom" id="timeDiv'+i+'"><span class="timetext">对比时间段</span><span class="times"><input type="text" data-format="yyyy-mm-dd" class="form-controls form-control datepicker" id="start'+i+'" onclick="checkTime(1,'+i+')"  onchange="checkTime(1,'+i+')" readonly="readonly" value="'+t+'"></span><lable class="spare">至</lable><span class="times"><input type="text" data-format="yyyy-mm-dd" class="form-controls form-control datepicker" id="end'+i+'"  onclick="checkTime(2,'+i+')" onchange="checkTime(2,'+i+')"  readonly="readonly" value="'+s+'"></span><span class="img"><img src="images/icon/delete.png"></span></div>'),l.appendTo($("#compare .addTime")),bindListener("compare"),ULTRA_SETTINGS.otherScripts(),i--})}else{var l="";i=e.length,$.each(e,function(e,a){l=$('<div class="historyInputCom1"  id="timeDiv'+i+'"><span class="timetext">对比时间段</span><span class="times">之前的第</span><section class="btn-group downselect"><button aria-expanded="false" data-toggle="dropdown" class="btn  btn-border dropdown-toggle" type="button" id="days'+i+'" style="width:95px;margin-left:0px" onclick="selectDrown('+i+","+s+')"><span class="txt" rel="'+Math.abs(a.day)+'">'+Math.abs(a.day)+'</span><span class="carets sarrow"></span><span class="sr-only"></span></button><ul role="menu" class="dropdown-menu  dropList dropList'+i+'"><li><a href="#" rel="1" class="selected">1</a></li><li><a href="#" rel="2">2</a></li><li><a href="#" rel="3">3</a></li><li><a href="#" rel="4">4</a></li><li><a href="#" rel="5">5</a></li><li><a href="#" rel="6">6</a></li><li><a href="#" rel="7">7</a></li><li><a href="#" rel="8">8</a></li><li class="9"><a href="#" rel="9">9</a></li></ul></section><lable class="spare" style="padding-left:0px;">'+r+'</lable><span class="times historyCom1Span" id="tians_'+i+'"></span><span class="spare">至</span><span class="times historyCom1Span" id="tiane_'+i+'"></span><span class="img"><img src="images/icon/delete.png"></span></div>'),l.appendTo($("#compare1 .addTime")),initAddreletiveAdd(s,i,Math.abs(a.day)),bindListener("compare1"),i--})}}function selectCharts(e){$(".getpic a").removeClass("active");var a=checkTree("tree"),t=a[1],s=a[0];if(0==s){$("#lineCharts").html("");$("#lineCharts").append('<span id="sTitle" class="sTitle">统计对象为空</span>')}if(s>0&&s<=16){if($(e).addClass("active"),1==isHistoryData){loadHighcharData("screening","screening","screening",judgeCompare())}0==isHistoryData&&bindCharts(s,t)}else 0!=s&&layer.msg("请选择不超过16条统计对象进行对比")}function selectDate(e){$(".getshi a").removeClass("active"),$(e).addClass("active");var a=checkTree("tree",1)[0];if(0==a){$("#lineCharts").html("");$("#lineCharts").append('<span id="sTitle" class="sTitle">统计对象为空</span>')}if(a>0&&a<=16){if(1==isHistoryData){loadHighcharData("screening","screening","screening",judgeCompare())}0==isHistoryData&&bindCharts(a)}else 0!=a&&layer.msg("请选择不超过16条统计对象进行对比");$("lineCharts").html("NTD026")}function bindCharts(treenodecount,ids){var chardatetype=$(".getshi a.active").attr("id"),charname=$(".getpic a.active").attr("id"),graph_type="1";"pie"==charname&&(graph_type="2");var _r="HistoryDataTagsContrast",statistic_type=chardatetype,start_time=$("#selectTime").val(),end_time=$("#endTime").val(),tagGroups=[],tags=[];$.each($("#tree input[class*='skin-square-green']:checked"),function(e,a){3==$(this).attr("id").split("-").length?tagGroups.push($(this).attr("ids")):tags.push($(this).attr("ids"))});var colors=["#A4CD52","#E7706F","#9B77B3","#4CB3E3","#9B77B3","#477B36","#EABE43","#135083","#8B6527","#B3CE59","#E8767B","#9980AF","#5CB1E1","#A977AB","#427A46","#D7AA5E","#3B507B","#3B507B","#996725","#C0D060","#EA7D86","#9789AA","#67AEDE","#B576A2","#3C7856","#C2956F","#594F73","#A66922","#CDD065","#EC8392","#9491A3","#71ABDB","#C07698","#347667","#AF817C","#714F6A","#B46B1F","#D9D06D","#ED8A9F","#91989A","#7AA7D7","#CA758E","#2D7477","#9C6D84","#864E61","#C06C1C","#E4CF73","#EE91AB","#8D9E90","#83A4D4","#D57484","#237286","#895989","#9A4C59","#CC6E19","#EECE79","#F098B7","#89A584","#8BA0D1","#DE717A","#1D7095","#75468E","#AC494F","#D86F14","#F7CC7F","#FFA2CB","#85AB77","#919BCD","#E7706F","#E7706F","#1A6DA3","#62328F","#62328F","#BC4746","#E47113"];datas={graph_type:graph_type,statistics_type:statistic_type,start_time:start_time,end_time:end_time+" 23:59:59",energy_group_ids:tagGroups,tag_ids:tags};var tagdic={};for(var tagkey in tags)tagdic[tags[tagkey]]=tags[tagkey];var tagarr=[];for(var tagkeys in tagdic)tagarr.push(tagkeys);tags.length!==tagarr.length?layer.msg("筛选tag重复"):$.ajax({type:"PUT",url:apiurl+_r,dataType:"json",data:datas,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(result){if(result.success){if("pie"==charname)if(result.success){var seriesdata="[";if(result.success){var j=0;for(var keypie in result.data){var values=result.data[keypie];Number(values)<0&&(values=0),seriesdata+='{name:"'+keypie+'",y:'+values+',color:"'+colors[j]+'"},',j++}seriesdata=seriesdata.substring(0,seriesdata.length-1),seriesdata+="]"}}else seriesdata="[无能耗数据]";else if(result.success){var returndata="[",areadata="[",i=0;for(var key in result.data){returndata+="{name:'"+result.data[key].name+"',marker:{enabled:true,radius:3},color:'"+colors[i]+"',data:[",areadata+="{name:'"+result.data[key].name+"',color:'"+colors[i]+"',data:[";var datename="";if(isEmptyObject(result.data[key].values))returndata+="]",areadata+="]";else{var data_key_values=result.data[key].values;for(var keys in data_key_values){switch(chardatetype){case"hour":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/"+keys.substring(6,8)+" "+keys.substring(8,10)+":00:00";break;case"day":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/"+keys.substring(6,8)+" 00:00:00";break;case"month":datename=keys.substring(0,4)+"/"+keys.substring(4,6)+"/01 00:00:00";break;case"year":datename=keys.substring(0,4)+"/01/01 00:00:00"}var datestr=new Date(datename);datestr=datestr.getTime()+288e5,returndata+="["+datestr+","+data_key_values[keys]+"],",areadata+="["+datestr+","+data_key_values[keys]+"],"}}returndata=returndata.substring(0,returndata.length-1)+"]},",areadata=areadata.substring(0,areadata.length-1)+"]},",i++}returndata=returndata.substring(0,returndata.length-1)+"]",areadata=areadata.substring(0,areadata.length-1)+"]"}else returndata="[无能耗数据]",areadata="[无能耗数据]";"column"==charname||"spline"==charname?$("#lineCharts").highcharts("StockChart",{chart:{backgroundColor:"#1C203F",alignTicks:!0,type:""+charname},tooltip:{xDateFormat:"%Y-%m-%d %H:%M:%S",shared:!0},rangeSelector:{allButtonsEnabled:!0,enabled:!1,buttonTheme:{width:60},selected:2},navigator:{enabled:!0,xAxis:{labels:{style:{color:"#fff"}},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H点",day:"%Y年%m月%d日",week:"%e. %b",month:"%Y年%m月",year:"%Y年"}}},title:{text:""},legend:{symbolHeight:12,symbolWidth:18,symbolRadius:0,itemStyle:{color:"#ffffff"},layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!0,labelFormatter:function(){var e;return e='<a title="'+this.name+'">',this.name.length>10?(e+=this.name.substring(0,5),e+="...",e+=this.name.substring(this.name.length-5,this.name.length)):e+=this.name,e+="</a>"}},exporting:{enabled:!1},credits:{enabled:!1},xAxis:{labels:{style:{color:"#ffffff"}},lineColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"}},yAxis:{labels:{style:{color:"#ffffff"}},gridLineColor:"#555769",opposite:!1,title:{style:{color:"#ffffff"},text:"耗电量(kWh)"}},series:"[无能耗数据]"==returndata?null:eval("("+returndata+")")}):"pie"==charname?$("#lineCharts").highcharts({chart:{backgroundColor:"#1C203F",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name} : <b>{point.percentage:.1f}% ({point.y})</b>"},credits:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"#fff",fontWeight:"bold",textOutline:"none"}}}},series:[{type:"pie",name:"占比",data:"[无能耗数据]"==seriesdata?null:eval("("+seriesdata+")")}]}):"area"==charname&&$("#lineCharts").highcharts("StockChart",{chart:{backgroundColor:"#1C203F",type:"column"},tooltip:{xDateFormat:"%Y-%m-%d %H:%M:%S",shared:!0},rangeSelector:{allButtonsEnabled:!0,enabled:!1,buttonTheme:{width:60},selected:2},navigator:{enabled:!0,xAxis:{labels:{style:{color:"#fff"}},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H点",day:"%Y年%m月%d日",week:"%e. %b",month:"%Y年%m月",year:"%Y年"}}},title:{text:""},legend:{symbolHeight:12,symbolWidth:18,symbolRadius:0,itemStyle:{color:"#ffffff"},layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,enabled:!0,labelFormatter:function(){var e;return e='<a title="'+this.name+'">',this.name.length>10?(e+=this.name.substring(0,5),e+="...",e+=this.name.substring(this.name.length-5,this.name.length)):e+=this.name,e+="</a>"}},exporting:{enabled:!1},credits:{enabled:!1},xAxis:{labels:{style:{color:"#ffffff"}},lineColor:"#555769",type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d %H:00",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y-"}},yAxis:{labels:{style:{color:"#ffffff"}},gridLineColor:"#555769",opposite:!1,title:{style:{color:"#ffffff"},text:"耗电量(kWh)"}},plotOptions:{column:{stacking:"normal"}},series:"[无能耗数据]"==areadata?null:eval("("+areadata+")")})}else{$("#lineCharts").html("");var spanwarn='<span id="sTitle" class="sTitle">无能耗数据</span>';$("#lineCharts").append(spanwarn)}},error:function(e){$("#lineCharts").html(""),publicAjaxError(e)}})}function isEmptyObject(e){var a;for(a in e)return!1;return!0}function table_content(e,a){var t="";if(t+="<tr>",t+="<th>名称</th>",1==e)for(var s=0;s<24;s++)t+="<th>"+s+"时</th>";else if(2==e){if(a){var i=a.split("-");a=getMothCount(i[0],i[1]);for(var s=1;s<a+1;s++)t+="<th>"+s+"号</th>"}}else if(3==e)for(var s=1;s<13;s++)t+="<th>"+s+"月</th>";t+="</tr>",$("#baoList thead").html(t)}function initData(e){if(2==e){""!=$("#bao_leftNames").html()||(leftList(2),rightTree("trees"),window.onresize=function(){initScrollerA("trees"),initScrollerA("bao_leftNames")},initScrollerA("trees"),initScrollerA("bao_leftNames"),$("#trees input.skin-square-green").on("ifUnchecked ifChecked",function(){checkTree("trees",1)}),$("#tab_border").css("opacity","0"))}}function BaoTableList(){var e=$("#selectTypes .txt").attr("rel"),a=checkTree("trees",1),t=a[0],s="",i="",r="";if(t<=0)return $("#noloud span.kong").text("未选择任何对象"),$("#noloud").show(),$("#tab_border").hide(),void $("#tongjis").hide();switch(e){case"1":i=$("#bao_day").val(),r="day";break;case"2":i=$("#bao_month").val(),r="month";break;case"3":i=$("#bao_year").val(),r="year"}var l=[],n=[];$.each($("#trees input[class*='skin-square-green']:checked"),function(e,a){3==$(this).attr("id").split("-").length?l.push($(this).attr("ids")):n.push($(this).attr("ids"))});var o={statistics_type:r,start_time:i,energy_group_ids:l,tag_ids:n};$.ajax({type:"GET",url:apiurl+"energyreportdata",dataType:"json",data:o,beforeSend:function(){$(".loading").show()},success:function(a){if($(".loading").hide(),a.success){var t=!0;for(var r in a.data)if(!isEmptyObject(a.data[r])){t=!1;break}if(t)$("#noloud span.kong").text("暂无数据"),$("#noloud").show(),$("#tab_border").hide();else{2==e?table_content(e,i):table_content(e);var l=a.data;for(var r in l){s+="<tr><td>"+l[r].name+"</td>";for(var n in l[r].values)s+="<td>"+l[r].values[n]+"</td>";s+="</tr>"}$("#tab_border").css("opacity","1"),$("#noloud").hide(),$("#tab_border").show(),$("#baoList tbody").html(s)}}else $("#noloud span.kong").text("暂无数据"),$("#tab_border").hide(),$("#noloud").show()},complete:function(){$(".loading").hide()},error:function(e){publicAjaxError(e)}}),$("#tongjis").hide()}function changeTime(){$("#bao_day").datepicker().on("changeDate",function(e){BaoTableList()}),$("#bao_month").datepicker().on("changeDate",function(e){BaoTableList()}),$("#bao_year").datepicker().on("changeDate",function(e){BaoTableList()})}function RegeMatch(e){var a=new RegExp(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5\-_]/g);if(""!=e.val()&&null!=e)return!a.test(e.val())}function fileName_s(e,a){var t=$("#"+e).val(),s=0,i=new RegExp("[`~\\\\!@#$%^&*()_+<>?？:\"{},，。！./;'[\\]]");if(t){if(i.test(t))return $("#"+e).next().html("不能输入特殊字符").show(),!1;for(var r=0;r<t.length;r++)t.charCodeAt(r)>127||94==t.charCodeAt(r)?s+=2:s++;if(s>64)return layer.msg("输入超过规定长度"),!1;if(1==a){var l=!0;if($("#leftNames ul").find("li span a").each(function(){if($(this).html()==t)return l=!1,!1}),!l)return layer.msg("该名称已经存在"),!1}else{var l=!0;if($("#bao_leftNames ul").find("li span a").each(function(){if($(this).html()==t)return l=!1,!1}),!l)return $("#"+e).next().html("该名称已经存在").show(),!1}return $("#"+e).next().hide(),!0}}function exportss(){var e;switch(Number($("#selectBao button .txt").attr("rel"))){case 1:e=$("#bao_day").val();break;case 2:e=$("#bao_month").val();break;case 3:e=$("#bao_year").val()}tableExport("baoList",e,"csv")}$("#foot").load("public.html");var enetgy_url="/index.php?r=",enetgy_urls="/index.php";$(document).ready(function(){rightTree("tree"),window.onresize=function(){initScrollerA("tree"),initScrollerA("leftNames")},initScrollerA("tree"),initScrollerA("leftNames")}),document.addEventListener("fullscreenchange",function(e){}),document.addEventListener("webkitfullscreenchange",function(e){!document.webkitIsFullScreen&&$("#tab_border header").hide()});var i=0,creatediv=function(){var e="",a=$("#selectType .txt").attr("rel"),t=9==a?"compare":"compare1";if($("#"+t+" .addTime").find("div[id^='timeDiv']").length<=8){var s=$("#"+t+" .addTime div").attr("id");i=void 0!=s?Number(s.substring(7))+1:1,$("#"+t+" .addTime").find("#timediv");var r="";9==a?r=$('<div class = "historyInputCom"><span class="timetext">对比时间段</span><span class="times"><input  type="text" data-format="yyyy-mm-dd" class="form-controls form-control datepicker" id="start'+i+'" onclick="checkTime(1,'+i+')"  onchange="checkTimeforZidingyiHistory(1,'+i+')" readonly="readonly"></span><lable class="spare">至</lable><span class="times"><input type="text" data-format="yyyy-mm-dd" class="form-controls form-control datepicker" id="end'+i+'"  onclick="checkTime(2,'+i+')" onchange="checkTime(2,'+i+')"  readonly="readonly"></span><span class="img"><img src="images/icon/delete.png"></span></div>'):(1!=a&&2!=a||(e="天"),3!=a&&4!=a&&5!=a||(e+="个",3==a?e+="3":4==a?e+="7":5==a&&(e+="30"),e+="天"),6!=a&&7!=a&&8!=a||(e="个月"),r=$('<div class = "historyInputCom1"><span class="timetext">对比时间段</span><span class="times">之前的第</span><section class="btn-group downselect"><button aria-expanded="false" data-toggle="dropdown" class="btn  btn-border dropdown-toggle" type="button" id="days'+i+'" style="width:95px;margin-left:0px" onclick="selectDrown('+i+","+a+')"><span class="txt" rel="1">1</span><span class="carets sarrow"></span><span class="sr-only"></span></button><ul role="menu" class="dropdown-menu  dropList dropList'+i+'"><li><a href="#" rel="1" class="selected">1</a></li><li><a href="#" rel="2">2</a></li><li><a href="#" rel="3">3</a></li><li><a href="#" rel="4">4</a></li><li><a href="#" rel="5">5</a></li><li><a href="#" rel="6">6</a></li><li><a href="#" rel="7">7</a></li><li><a href="#" rel="8">8</a></li><li class="9"><a href="#" rel="9">9</a></li></ul></section><lable class="spare" style="padding-left:0px;">'+e+'</lable><span class="times historyCom1Span" id="tians_'+i+'"></span><span class="spare">至</span><span class="times historyCom1Span" id="tiane_'+i+'"></span><span class="img"><img src="images/icon/delete.png"></span></div>')),r.attr("id","timeDiv"+i),r.addClass("parentdiv"),1==i&&r.appendTo($("#"+t+" .addTime")),1!=i&&$("#"+t+" .addTime div[id=timeDiv"+(i-1)+"]").before(r),$("#"+t).parent().height($("#"+t).parent().height()+47)}else layer.msg("不能超过9个时间段"),i=0;bindListener(t),9==a?ULTRA_SETTINGS.otherScripts():initAddreletiveAdd(a,i),$(".addTime").show(),$(".addTime div").show},isHistoryData=!1,history_ids;Date.prototype.format=function(e){var a={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var t in a){var s=a[t];new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?s:("00"+s).substr((""+s).length)))}return e};
function activeLastPointToolip(e){var t=1e9,a=0,i=[0,0],l=e.series[0].points;Highcharts.each(l,function(e){e.y>a&&(i[0]=e.index,a=e.y),null!=e.y&&e.y<t&&(i[1]=e.index,t=e.y)}),label_max+=1,label_min+=1,render_max(e,l[i[0]],'<br><span style="color:#B5A6B2">最大值</span>'),render_min(e,l[i[1]],'<br><span style="color:#B5A6B2">最小值</span>')}function render_max(e,t,a){e.renderer.label(Number(t.y.toFixed(3))+"kw"+a,t.plotX+e.plotLeft-20,t.plotY+e.plotTop,"callout",t.plotX+e.plotLeft,t.plotY+e.plotTop).css({color:"#F1F2F3",align:"center"}).attr({zIndex:6,id:"label_max"+label_max}).add()}function render_min(e,t,a){labels=e.renderer.label(Number(t.y.toFixed(3))+"kw"+a,t.plotX+e.plotLeft-20,t.plotY+e.plotTop-45,"callout",t.plotX+e.plotLeft,t.plotY+e.plotTop).css({color:"#F1F2F3",align:"center"}).attr({zIndex:6,id:"label_min"+label_min}).add()}function getHomePageMessage(){$.ajax({url:apiurl+"r=api/main/demo",type:"post",dataType:"json",data:null,beforeSend:function(){$(".loading").show()},success:function(e){if($(".loading").hide(),e.success){var t=e.data.realTimeTag;for(var a in t)switch(Number(t[a].tagId)){case 1422:case 1423:case 1424:case 1425:case 1426:case 1427:changeValue.pointValue(t[a]);break;case 1428:case 1429:case 1430:case 1431:case 1432:case 1433:case 1434:case 1435:changeValue.footValue(t[a]);break;case 1436:case 1437:changeValue.titleValue(t[a]);break;case 1438:case 1440:changeValue.rightValue(t[a])}$("#1436 li:nth-child(2) p:first-child").text(e.data.target[0]),$("#1437 li:nth-child(2) p:first-child").text(e.data.target[1]),isNaN($("#1436 li:nth-child(1) p:first-child").text())?$("#1436 li:nth-child(3) p:first-child").text("0"):$("#1436 li:nth-child(3) p:first-child").text((Number($("#1436 li:nth-child(1) p:first-child").text())/Number(e.data.target[0])*100).toFixed(2)),isNaN($("#1437 li:nth-child(1) p:first-child").text())?$("#1437 li:nth-child(3) p:first-child").text("0"):$("#1437 li:nth-child(3) p:first-child").text((Number($("#1437 li:nth-child(1) p:first-child").text())/Number(e.data.target[1])*100).toFixed(2));var i=e.data.power.data,l=i;Highcharts.chart("container",{chart:{backgroundColor:"#292E46",plotBorderColor:"#30354E",plotBorderWidth:1,plotBackgroundImage:"images/cbsnew/总功率.png",events:{load:function(){chart=this;var e=this.series[0];tagValueSetInterval=setInterval(function(){if(addData){var t=real_time,a=real_time_value;e.addPoint([t,a],!0,!1),$("#label_min"+label_min).remove(),$("#label_max"+label_max).remove(),activeLastPointToolip(chart),addData=!1}},1e3)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"},visible:!1},tooltip:{dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%Y-%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:""},gridLineWidth:0},legend:{enabled:!1},plotOptions:{area:{fillColor:{linearGradient:{x1:0,y1:-5,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]},marker:{radius:2,enabled:!1},lineWidth:1,states:{hover:{lineWidth:1}},threshold:null}},series:[{type:"area",name:"总功率",data:l,lineWidth:.5,lineColor:"#438FBE"}]},function(e){e=this,0==l.length||activeLastPointToolip(e)}),MQTTconnect()}else layer.msg(e.error_message),returnLogIn(e.error_message)},error:function(e){$(".loading").hide(),layer.msg(e.error_message)}})}function MQTTconnect(){var e={useSSL:!1,cleanSession:!1,onSuccess:function(){subscribeView()},onFailure:function(e){setTimeout(MQTTconnect,reconnectTimeout)}};mqtt.onConnectionLost=onConnectionLost,mqtt.onMessageArrived=onMessageArrived,mqtt.connect(e)}function subscribeView(){mqtt.subscribe("Bayax/Push/"+view_id);var e=new Paho.MQTT.Message(view_id);e.destinationName="Bayax/View/"+clientID,e.qos=0,setIntvals=setInterval(function(){mqtt.send(e)},3e4)}function onConnectionLost(e){clearInterval(setIntvals),setTimeout(MQTTconnect,reconnectTimeout)}function onMessageArrived(e){var t=JSON.parse(e.payloadString);switch(Number(t.tagId)){case 1422:case 1423:case 1424:case 1425:case 1426:case 1427:changeValue_mqtt.pointValue(t);break;case 1428:case 1429:case 1430:case 1431:case 1432:case 1433:case 1434:case 1435:changeValue_mqtt.footValue(t);break;case 1436:case 1437:changeValue_mqtt.titleValue(t);break;case 1438:case 1440:changeValue_mqtt.rightValue(t);break;case 1442:addData=!0,real_time=new Date(t.time).format("yyyy-MM-dd hh:mm:ss"),real_time_value=Number(Number(t.value).toFixed(2))}}function changeBodyHeight(){Number(window.outerHeigth)===Number(screen.height)&&Number(window.outerWidth)==Number(screen.width)?$("body").css("padding-top","0"):$("body").css("padding-top","2%"),window.outerHeight===screen.availHeight&&window.outerWidth===screen.availWidth?$("body").css("padding-top","0"):$("body").css("padding-top","2%")}$("#foot").load("public.html"),$(function(){publicHeadfun(),getHomePageMessage()}),$(function(){$("#container-pie").highcharts({chart:{backgroundColor:"#292E46",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},credits:{enabled:!1},title:{text:""},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{distance:5,enabled:!0,format:"{point.percentage:.1f} %",style:{color:"#BFD3DF",fontSize:"11px",fontWeight:"bold",textOutline:"none"}},showInLegend:!0}},legend:{align:"left",layout:"vertical",verticalAlign:"middle",itemMarginBottom:8,itemStyle:{color:"#7A8FAC;",fontWeight:"bold"},x:-10,y:50},series:[{type:"pie",name:"能耗占比",data:[{name:"空调",y:37,color:"#1B70B0"},{name:"照明",y:28,color:"#298372"},{name:"办公",y:22,color:"#8268BE"},{name:"其他",y:13,color:"#5DBAC9"}]}]})});var label_max=0,label_min=0;$(".point-monitor p:last-child").hover(function(){var e=Number($(this).offset().top)-30,t=Number($(this).offset().left)+20,a=$('<div class="hover-tips"><p>'+$(this).data("name")+"</p></div>");$("body").append(a.css({top:e+"px",left:t+"px"}))},function(){$(".hover-tips").remove()});var changeValue={};changeValue=function(e){return e.pointValue=function(e){$("#"+e.tagId+" p:last-child").data("name",e.message),e.alarm&&($("#"+e.tagId+" p:first-child").hide(),$("#"+e.tagId+" p:last-child").show())},e.footValue=function(e){e.alarm?$("#"+e.tagId+" p:last-child").html('异常<img class="css3-warn" src="images/cbsnew/baojing.png">'):$("#"+e.tagId+" p:last-child").html("正常")},e.titleValue=function(e){isNaN(e.value)?$("#"+e.tagId+" li:first-child p:first-child").text("异常"):$("#"+e.tagId+" li:first-child p:first-child").text(e.value)},e.rightValue=function(e){isNaN(e.value)?$("#"+e.tagId).text("异常"):$("#"+e.tagId).text(e.value)},e}(changeValue);var changeValue_mqtt={};changeValue_mqtt=function(e){return e.pointValue=function(e){e.isAlarm?($("#"+e.tagId+" p:first-child").hide(),$("#"+e.tagId+" p:last-child").show()):($("#"+e.tagId+" p:first-child").show(),$("#"+e.tagId+" p:last-child").hide())},e.footValue=function(e){e.isAlarm?$("#"+e.tagId+" p:last-child").html('异常<img class="css3-warn" src="images/cbsnew/baojing.png">'):$("#"+e.tagId+" p:last-child").html("正常")},e.titleValue=function(e){if(isNaN(e.value))$("#"+e.tagId+" li:first-child p:first-child").html("异常"),$("#"+e.tagId+" li:nth-child(3) p:first-child").html("0");else{$("#"+e.tagId+" li:first-child p:first-child").html(e.value);var t=Number(e.value)/Number($("#"+e.tagId+" li:nth-child(2) p:first-child").text())*100;$("#"+e.tagId+" li:nth-child(3) p:first-child").html(t.toFixed(2))}},e.rightValue=function(e){$("#"+e.tagId).text(Number(e.value).toFixed(2))},e}(changeValue_mqtt);var addData=!1,real_time="",real_time_value=0,view_id="9999",mqtt,reconnectTimeout=2e3,clientID="123",timeout=!1,setIntvals;mqtt=new Paho.MQTT.Client("192.168.2.2",61614,String(parseInt(100*Math.random(),10))),$(".left-center-foot li a").on("click",function(){sessionStorage.setItem("device_viewid",$(this).data("id"))}),$(function(){changeBodyHeight()}),window.onresize=function(){changeBodyHeight()};
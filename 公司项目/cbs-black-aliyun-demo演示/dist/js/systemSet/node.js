$(function(){node.getProjectId()}),window.$node={btn_creat:$("#node-creat"),btn_delete:$("#node-delete"),btn_save:$("#node-save"),search_input:$("#content-search-input"),node_name:$("#node-name"),node_mac:$("#node-mac"),node_timeout:$("#node-timeout"),node_desc:$("#node-desc"),loading:$(".loading"),name_warn:$("#name-warn"),name_instructions:$("#name-instructions"),mac_warn:$("#mac-warn"),mac_instructions:$("#mac-instructions"),timeout_warn:$("#timeout-warn"),timeout_instructions:$("#timeout-instructions"),desc_warn:$("#desc-warn"),desc_instructions:$("#desc-instructions")};var node={};node=function(e){var n;return e.savePage=0,e.projectId=0,e.getProjectId=function(){$.ajax({url:apiurl+"project",type:"get",success:function(o){o.success?($("#logo").attr("src",o.data.logo_path),e.projectId=o.data.id,n=o.data.id,e.jiedianguanliLoadData(!1,1)):layer.msg(o.error_message)},error:function(e){layer.msg(e.error_message),returnLogIn(e)}})},e.jiedianguanliLoadData=function(o,t){var a;e.savePage=t,a=o?{name:$node.search_input.val(),project_id:n,page:t,page_item_count:13}:{project_id:n,page:t,page_item_count:13},$.ajax({url:apiurl+"node",type:"get",dataType:"json",data:a,beforeSend:function(){$node.loading.show()},complete:function(){$node.loading.hide()},success:function(n){$node.loading.hide(),n.success?(e.jqaddRow(n.data.items),null==n.data||0===Number(n.data.length)?($(".tcdPageCode").hide(),layer.msg("无数据")):$(".tcdPageCode").createPage({pageCount:n.data.pageCount,current:t,backFn:function(n){e.savePage=n,""===$node.search_input.val()?e.jiedianguanliLoadData(!1,n):e.jiedianguanliLoadData(!0,n)}})):layer.msg(n.data)},error:function(e){publicAjaxError(e)}})},e.jqaddRow=function(n){null==n&&(n=[]),$("#node-tabody tr td").html(""),$("#node-tabody tr").each(function(e,o){if(e<n.length){var t='<td><input  type="checkbox"  class="ckss" data-id = "'+n[e].id+'"  name="ckss"/></td><td>'+n[e].name+"</td><td>"+n[e].address+"</td><td>"+n[e].timeout+"</td><td>"+n[e].description+'</td><td><a href="#" data-id="'+n[e].id+'" class="edit-node">编辑</a><a href="#" data-id="'+n[e].id+'" class="delete-node">删除</a></td>';$(o).html(t)}}),e.icheckInte()},e.deleteNode=function(n,o){$.ajax({url:apiurl+"node/?ids="+n.join(","),type:"DELETE",beforeSend:function(){$node.loading.show()},complete:function(){$node.loading.hide()},success:function(n){$node.loading.hide(),n.success?(layer.msg("删除成功"),""===$("#content-search-input").val()?e.jiedianguanliLoadData(!1,e.savePage):e.jiedianguanliLoadData(!0,e.savePage)):layer.msg(n.error_message)},error:function(e){publicAjaxError(e)}})},e.clearData=function(){$(".node-form-edit input").val(""),$(".node-form-edit .warn-span").text("").hide(),$(".node-form-edit .instructions").show(),$("textarea").val("")},e.icheckInte=function(){$("input").iCheck("destroy"),$(".ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"})},e.checkInt=function(e,n,o){var t=new RegExp(/[^0-9]/g);if(""!=e.val()&&null!=e&&t.test(e.val()))return o.hide(),n.show().text("输入不合法"),!1},e.checkmac=function(e,n,o){var t=new RegExp(/[^\a-\z\A-\Z0-9]/g);if(""!=e.val()&&null!=e&&t.test(e.val()))return o.hide(),n.show().text("输入不合法"),!1},e}(node),$("#node-tabody").on("click","a.edit-node",function(e){$node.btn_save.data("type","edit"),$node.btn_save.data("id",$(this).data("id")),node.clearData();var n=$(this);layer_open=layer.open({title:["编辑节点","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["60%","500px"],content:$("#layer-node-new"),shift:2,move:!1,btn:["保存","放弃"],success:function(){var e=n.parent().parent();$node.node_name.val(e.find("td:nth-child(2)").text()),$node.node_mac.val(e.find("td:nth-child(3)").text()),$node.node_timeout.val(e.find("td:nth-child(4)").text()),$node.node_desc.val(e.find("td:nth-child(5)").text())},yes:function(e){$node.btn_save.click()},btn2:function(e){layer.close(e)}}),e&&e.stopPropagation&&e.stopPropagation()}),$("#node-tabody").on("click","a.delete-node",function(e){$this=$(this);var n=layer.open({title:["删除节点","font-size:18px;color:#fff;background:#3E4687;border:none;height:50px;font-weight:bold;line-height:50px;padding-left:10px"],type:1,skin:"layui-primary",area:["600px","200px"],content:$("#layer-delete-node"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$("#layer-delete-node p").text("确认删除该节点吗")},yes:function(e){var o=[$this.data("id")];node.deleteNode(o,n),layer.close(e)},btn2:function(e){layer.close(e)}})}),$("#node-delete").on("click",function(){var e=!1;if($("input[name='ckss']:checkbox").each(function(n,o){if($(o).is(":checked"))return e=!0,!1}),e){$this=$(this);var n=layer.open({title:["删除节点","font-size:18px;color:#fff;background:#3E4687;border:none;height:50px;font-weight:bold;line-height:50px;padding-left:10px"],type:1,skin:"layui-primary",area:["600px","200px"],content:$("#layer-delete-node"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$("#layer-delete-node p").text("确认删除所有选中的节点吗")},yes:function(e){var o=[];$("input[name='ckss']:checkbox").each(function(e,n){$(n).is(":checked")&&o.push($(n).data("id"))}),node.deleteNode(o,n),layer.close(e)},btn2:function(e){layer.close(e)}})}else layer.msg("请至少选择一个节点")});var layer_open;$("#node-creat").on("click",function(){$node.btn_save.data("type","creat"),layer_open=layer.open({title:["新建节点","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,closeBtn:1,skin:"layui-primary",area:["60%","500px"],content:$("#layer-node-new"),shift:2,move:!1,btn:["保存","放弃"],success:function(){node.clearData()},yes:function(e){$node.btn_save.click()},btn2:function(e){layer.close(e)}})}),$node.btn_save.on("click",function(){var e=!0,n=!0;if($(".node-form-edit span.warn-span").each(function(n,o){if(""!==$(o).text())return e=!1,!1}),$(".node-form-edit input").each(function(e,o){if(""===$(o).val())return n=!1,!1}),!0===n&&!0===e)if("creat"===$(this).data("type")){layer.msg("可以新建");node.projectId,$node.node_name.val(),$node.node_mac.val(),Number($node.node_timeout.val()),$node.node_desc.val();$.ajax({url:apiurl+"node",type:"post",dataType:"json",data:{project_id:node.projectId,name:$node.node_name.val(),address:$node.node_mac.val(),timeout:Number($node.node_timeout.val()),description:$node.node_desc.val()},beforeSend:function(){$node.loading.show()},complete:function(){$node.loading.hide()},success:function(e){$node.loading.hide(),e.success?(""===$node.search_input.val()?node.jiedianguanliLoadData(!1,node.savePage):node.jiedianguanliLoadData(!0,node.savePage),layer.close(layer_open),layer.msg("创建成功")):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}else{node.projectId,$(this).data("id"),$node.node_name.val(),$node.node_mac.val(),Number($node.node_timeout.val()),$node.node_desc.val();$.ajax({url:apiurl+"node",type:"PUT",dataType:"json",data:{project_id:node.projectId,id:$(this).data("id"),name:$node.node_name.val(),address:$node.node_mac.val(),timeout:Number($node.node_timeout.val()),description:$node.node_desc.val()},beforeSend:function(){$node.loading.show()},complete:function(){$node.loading.hide()},success:function(e){$node.loading.hide(),e.success?(""===$node.search_input.val()?node.jiedianguanliLoadData(!1,node.savePage):node.jiedianguanliLoadData(!0,node.savePage),layer.close(layer_open),layer.msg("修改成功")):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}else!1===n&&!0===e&&layer.msg("输入框不能为空"),!1===e&&!0===n&&layer.msg("请检查输入是否准确"),!1===e&&!1===n&&layer.msg("请检查输入是否准确")}),$("#clearImage").on("click",function(){$node.search_input.val(""),node.jiedianguanliLoadData(!1,1)}),$node.search_input.on("input",function(){""===$node.search_input.val()?node.jiedianguanliLoadData(!1,1):node.jiedianguanliLoadData(!0,1)}),$node.node_name.on("input",function(){if($node.name_instructions.show(),$node.name_warn.hide().text(""),RegeMatch($node.node_name,$node.name_warn,$node.name_instructions),""==$node.node_name.val()&&""==$node.name_warn.text()&&($node.name_instructions.hide(),$node.name_warn.show().text("不能为空")),""==$node.name_warn.text()){chEnWordCount($node.node_name.val())>60&&($node.name_instructions.hide(),$node.name_warn.show().text("字符超出限制"))}}),$node.node_name.blur(function(){if(""==$node.name_warn.text())if(""==$node.node_name.val())$node.name_instructions.hide(),$node.name_warn.show().text("不能为空");else{var e=chEnWordCount($node.node_name.val());e>60&&($node.name_instructions.hide(),$node.name_warn.show().text("字符超出限制"))}}),$node.node_mac.on("input",function(){$node.mac_instructions.show(),$node.mac_warn.hide().text("")}),$node.node_mac.blur(function(){if(""==$node.mac_warn.text())if(""==$node.node_mac.val())$node.mac_instructions.hide(),$node.mac_warn.show().text("不能为空");else{var e=/[A-Fa-f0-9]{2}[A-Fa-f0-9]{2}[A-Fa-f0-9]{2}[A-Fa-f0-9]{2}[A-Fa-f0-9]{2}[A-Fa-f0-9]{2}/;e.test($node.node_mac.val())||($node.mac_instructions.hide(),$node.mac_warn.show().text("地址格式不正确"))}}),$node.node_timeout.on("input",function(){if($node.timeout_instructions.show(),$node.timeout_warn.hide().text(""),node.checkInt($node.node_timeout,$node.timeout_warn,$node.timeout_instructions),""==$node.node_timeout.val()&&""==$node.timeout_warn.text()&&($node.timeout_instructions.hide(),$node.timeout_warn.show().text("不能为空")),""==$node.timeout_warn.text()){var e=Number($node.node_timeout.val());(e<0||e>3600)&&($node.timeout_instructions.hide(),$node.timeout_warn.show().text("超出限制"))}}),$node.node_timeout.blur(function(){if(""==$node.timeout_warn.text())if(""==$node.node_timeout.val())$node.timeout_instructions.hide(),$node.timeout_warn.show().text("不能为空");else{var e=Number($node.node_timeout.val());(e<0||e>3600)&&($node.timeout_instructions.hide(),$node.timeout_warn.show().text("超出限制"))}}),$node.node_desc.on("input",function(){if($node.desc_instructions.show(),$node.desc_warn.hide().text(""),RegeMatch($(this),$node.desc_warn,$node.desc_instructions),""==$node.desc_warn.text()){chEnWordCount($node.node_desc.val())>60&&($node.desc_instructions.hide(),$node.desc_warn.show().text("字符超出限制"))}});
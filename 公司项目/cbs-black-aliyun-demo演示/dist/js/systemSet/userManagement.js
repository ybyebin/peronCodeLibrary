function getUserMessage(){$.ajax({url:apiurl+"usermanage",type:"get",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?addUserMessageToTable(e.data.items):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}function addUserMessageToTable(e){if(null==e)e=[{id:""}];else for(var a in e)switch(Number(e[a].system_role_id)){case 1:e[a].system_role_id="管理员";break;case 2:e[a].system_role_id="普通"}if(e.length<14)for(var s=14-e.length,i=0;i<s;i++){var d={id:""};e.push(d)}$("#user-message-tbody").html("");for(var r=$("#user-Message-tbody").html(),i=0;i<e.length;i++){if(""==e[i].id)var t='<tr data-id=""><td></td><td></td><td></td><td></td><td></td></tr>';else var t='<tr data-id = "'+e[i].id+'" ><td>'+e[i].username+"</td><td>"+e[i].system_role_id+"</td><td>"+e[i].full_name+"</td><td>"+e[i].employee_id+"</td><td>"+e[i].last_login_time+"</td></tr>";r+=t}$("#user-message-tbody").html(r),$("#user-message-tbody").children("tr").first().click()}function graphicImageGetData(){$.ajax({url:apiurl+"subsystem",type:"get",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if($(".loading").hide(),e.success){var e=e.data.items;for(var a in e){dicGroup[e[a].id]=e[a].id;var s='<li><input id="edit'+e[a].id+'" data-id="'+e[a].id+'" class="ckss" type="checkbox" name="user-edit-ckss"><label>'+e[a].name+"</label></li>",i='<li><input id="add'+e[a].id+'" data-id="'+e[a].id+'" class="ckss" type="checkbox" name="user-add-ckss"><label>'+e[a].name+"</label></li>";$(".edit-user-ul ul").append(s),$(".add-user-ul ul").append(i)}$(".ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),getUserMessage()}else layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}function getUseDetailedInformation(e){$.ajax({url:apiurl+"usermanage/id",type:"get",dataType:"json",data:{id:e},beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if($(".loading").hide(),e.success){var a,s=e.data;switch(Number(s.system_role_id)){case 1:a="管理员";break;case 2:a="普通"}$(".display-cancel-user").data("id",s.id),$(".edit-save-user").data("id",s.id),$(".display-user-name").text(s.username),$(".display-role").text(a),$(".display-name").text(s.full_name),$(".display-staff-number").text(s.employee_id),$(".display-user-ul ul").html(""),$('.edit-user-ul input[name="user-edit-ckss"]').iCheck("uncheck");for(var i in s.user_view_group){var d='<li><input class="dis-ckss" type="checkbox" disabled="true" checked="checked"><label>'+s.user_view_group[i].name+"</label></li>";$(".display-user-ul ul").append(d),$(".dis-ckss").iCheck("destroy"),$(".dis-ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),dicGroup[s.user_view_group[i].id]&&$("#edit"+s.user_view_group[i].id).iCheck("check")}$(".edit-save-user").data("id",s.id),$(".edit-name").val(s.username),$(".edit-psw").val(""),$(".eidt-surepsw").val(""),$(".edit-fullname").val(s.full_name),$(".edit-ygnumber").val(s.employee_id),$(".edituserjaose").val(s.system_role_id)}else layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}function RegeMatchTwo(e){return!new RegExp(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5\\]/g).test(e)}!function(e){e(window).load(function(){e(".user-message-div").mCustomScrollbar(),e(".display-user-ul").mCustomScrollbar(),e(".edit-user-ul").mCustomScrollbar(),e(".add-user-ul").mCustomScrollbar()})}(jQuery),$("#foot").load("public.html");var dicGroup={};$(function(){publicHeadfun(),projectInfo(),graphicImageGetData()}),$("#user-message-tbody").on("click","tr",function(){""!==$(this).data("id")&&($(".message-div-detailed").hide(),$(".message-div-display").show(),$("#user-message-tbody tr").removeClass("actives"),$(this).addClass("actives"),getUseDetailedInformation($(this).data("id")))}),$("#btn-adduser").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-add").show(),$(".message-div-add input").val(""),$(".adduserjaose").val(2),$('.add-user-ul input[name="add-user-ckss"]').iCheck("unckeck")}),$(".add-save-user").on("click",function(){var e=$(".add-name").val(),a=$(".add-psw").val(),s=$(".add-surepsw").val(),i=$(".add-fullname").val(),d=$(".add-ygnumber").val(),r=[];if($('.add-user-ul input[name="user-add-ckss"]:checked').each(function(e,a){r.push({id:$(a).data("id")})}),""!==e&&""!=a&&""!==s)if(a===s)if(RegeMatchTwo(e)&&RegeMatchTwo(a)&&RegeMatchTwo(s)&&RegeMatchTwo(i)&&RegeMatchTwo(d)){var t={project_id:$("#navbar-brandImg").data("proid"),username:e,password:a,system_role_id:$(".adduserjaose").val(),full_name:i,employee_id:d,user_view_group:r};$.ajax({url:apiurl+"usermanage",type:"post",dataType:"json",data:t,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(layer.msg("创建成功"),getUserMessage(),$(".message-div-detailed").hide(),$(".message-div-display").show()):(layer.msg(e.error_message),returnLogIn(e.error_message))},error:function(e){publicAjaxError(e)}})}else layer.msg("输入信息不能包含特殊字符");else layer.msg("两次输入的密码不一致,请重新输入");else layer.msg("请确认信息填写完整")}),$(".add-save-cancel").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-display").show()}),$(".display-edit-user").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-edit").show()}),$(".display-cancel-user").on("click",function(){""!==$(this).data("id")?$.ajax({url:apiurl+"usermanage/"+$(this).data("id"),type:"DELETE",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?($(".message-div-display .center div label:nth-child(2)").text(""),$(".display-user-ul ul").html(""),layer.msg("删除成功"),getUserMessage()):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}}):layer.msg("请选中一条用户信息")}),$(".edit-save-user").on("click",function(){var e=$(".edit-name").val(),a=$(".edit-psw").val(),s=$(".eidt-surepsw").val(),i=$(".edit-fullname").val(),d=$(".edit-ygnumber").val(),r=[];if($('.edit-user-ul input[name="user-edit-ckss"]:checked').each(function(e,a){r.push({id:$(a).data("id")})}),""!==e&&""!=a&&""!==s)if(a===s)if(RegeMatchTwo(e)&&RegeMatchTwo(a)&&RegeMatchTwo(s)&&RegeMatchTwo(i)&&RegeMatchTwo(d)){var t={project_id:$("#navbar-brandImg").data("proid"),id:Number($(this).data("id")),username:e,password:a,system_role_id:$(".edituserjaose").val(),full_name:i,employee_id:d,user_view_group:r};$.ajax({url:apiurl+"usermanage/0",type:"PUT",dataType:"json",data:t,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(layer.msg("修改成功"),$(".message-div-detailed").hide(),$(".message-div-display").show(),getUserMessage()):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}else layer.msg("输入信息不能包含特殊字符");else layer.msg("两次输入的密码不一致,请重新输入");else layer.msg("请确认信息填写完整")}),$(".edit-save-cancel").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-display").show()});
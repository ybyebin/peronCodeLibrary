function checkOne(a,e){var t,l=!0,i=!0;switch($("#btn-save").data("type")){case"add":t="add";break;case"edit":t="edit"}switch(a){case"type-one":"add"===t?datalabel.creatDatalabel(e):(e.id=$("#btn-save").data("id"),datalabel.editDatalabels(e));break;case"type-two":$("#table-warn input.select-value").each(function(a,e){if(""===$(e).val())return l=!1,!1}),$("#table-warn input.select-desc").each(function(a,e){if(""===$(e).val())return i=!1,!1}),l&&i?"add"===t?datalabel.creatDatalabel(e):(e.id=$("#btn-save").data("id"),datalabel.editDatalabels(e)):layer.msg("界限值或报警描述不能为空")}}function checkjiexian(a){a.value=a.value.replace(/\D/g,"")}!function(a){a(window).load(function(){a("#layer-new-datalabel").mCustomScrollbar()})}(jQuery),$(function(){$(".ckss-edit").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),datalabel.getProjectId(),datalabel.loadNode(),datalabel.initData(),datalabel.booleans()});var datalabel={};datalabel=function(a){var e;return a.savePage=0,a.delete_warn=[],a.getProjectId=function(){$.ajax({url:apiurl+"project",type:"get",dataType:"json",success:function(t){t.success?($("#logo").attr("src",t.data.logo_path),e=t.data.id,a.shujubiaoqianLoadData(!1,1)):layer.msg(t.error_message)},error:function(a){layer.msg(a.error_message),returnLogIn(a)}})},a.shujubiaoqianLoadData=function(t,l){var i;a.savePage=l,i=t?{name:$("#content-search-input").val(),project_id:e,page:l,page_item_count:13}:{project_id:e,page:l,page_item_count:13},$.ajax({url:apiurl+"tag",type:"get",data:i,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(a.jqaddRow(e.data.items),null==e.data||0===Number(e.data.length)?($(".tcdPageCode").hide(),layer.msg("无数据")):$(".tcdPageCode").createPage({pageCount:e.data.pageCount,current:l,backFn:function(e){a.savePage=e,""===$("#content-search-input").val()?a.shujubiaoqianLoadData(!1,e):a.shujubiaoqianLoadData(!0,e)}})):layer.msg(e.error_message)},error:function(a){publicAjaxError(a)}})},a.jqaddRow=function(e){null==e&&(e=[]);for(var t in e)switch(Number(e[t].tag_type)){case 1:e[t].tag_type="开关型";break;case 2:e[t].tag_type="整数型";break;case 3:e[t].tag_type="实数型";break;case 4:e[t].tag_type="字符型"}$("#datalabel-tbodys tr td").html(""),$("#datalabel-tbodys tr").each(function(a,t){if(a<e.length){var l='<td><input  type="checkbox"  class="ckss" data-id = "'+e[a].id+'"  name="ckss"/></td><td>'+e[a].name+"</td><td>"+e[a].description+"</td><td>"+e[a].tag_type+"</td><td>"+e[a].node_name+"</td><td>"+e[a].point_id+'</td><td><a href="#" data-id="'+e[a].id+'" class="edit-datalabel">编辑</a><a href="#" data-id="'+e[a].id+'" class="delete-datalabel">删除</a></td>';$(t).html(l)}}),a.icheckInte()},a.initData=function(){$("#datalab-warn-val").attr("disabled","disabled"),$("#datalab-warn-level").attr("disabled","disabled"),$("#datalab-warn-des").attr("disabled","disabled"),$("#datalab-his-siquval").attr("disabled","disabled"),$("#datalab-fixed-val").attr("disabled","disabled"),$("#datalab-siqu").iCheck("disable"),$("#datalab-siquval").attr("disabled","disabled")},a.deleteTag=function(e){$.ajax({url:apiurl+"tag/?ids="+e.join(","),type:"DELETE",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(layer.msg("删除成功"),""===$("#content-search-input").val()?a.shujubiaoqianLoadData(!1,a.savePage):a.shujubiaoqianLoadData(!0,a.savePage)):layer.msg(e.error_message)},error:function(a){publicAjaxError(a)}})},a.oneTagMessage=function(e){$.ajax({url:apiurl+"tag/"+e,type:"get",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?layer_open=layer.open({title:["编辑标签","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["60%","80%"],content:$("#layer-new-datalabel"),shift:2,move:!1,btn:["保存","放弃"],success:function(){datalabel.cleanInput(),a.disDetailedMessag(e.data)},yes:function(a){$("#btn-save").click()},btn3:function(a){datalabel.cleanInput(),layer.close(a)}}):layer.msg(e.error_message)},error:function(a){publicAjaxError(a)}})},a.disDetailedMessag=function(e){$("#datalab-name").val(e.name),$("#datalab-des").val(e.description),$("#datalab-node").val(e.node_id),$("#datalab-register").val(e.point_id);var t=$("#datalab-readonly");e.is_readonly?t.iCheck("check"):t.iCheck("uncheck");var l=$("#datalab-acquisition-style");switch(e.collect_ode){case 1:l.val("1"),$("#datalab-acquisition-frequency").attr("disabled","disabled");break;case 2:l.val("2"),$("#datalab-acquisition-frequency").removeAttr("disabled");break;case 3:l.val("3"),$("#datalab-acquisition-frequency").removeAttr("disabled")}switch($("#datalab-acquisition-frequency").val(e.collect_nterval),e.tag_type){case 1:$("#datalab-type").val("1"),a.booleans();var i=$("#datalab-defaultvalue-switch");switch(Number(e.init_value)){case 1:i.val("1");break;case 0:i.val("0")}var n=$("#datalab-warn");if(null!==e.alarm_attributes){n.data("id",e.alarm_attributes[0].id),e.alarm_attributes[0].alarm_status?n.iCheck("check"):n.iCheck("uncheck");var d=$("#datalab-warn-val");switch(Number(e.alarm_attributes[0].value)){case 0:d.val("0");break;case 1:d.val("1")}var s=$("#datalab-warn-level");switch(Number(e.alarm_attributes[0].alarm_level)){case 1:s.val("3");break;case 2:s.val("2");break;case 3:s.val("1")}$("#datalab-warn-des").val(e.alarm_attributes[0].message)}a.historyMessage(e);break;case 2:$("#datalab-type").val("2"),a.integerAndFloat(),a.IntergerAndFloatMessage(e),a.historyMessage(e);break;case 3:$("#datalab-type").val("3"),a.integerAndFloat(),a.IntergerAndFloatMessage(e),a.historyMessage(e);break;case 4:$("#datalab-type").val("4"),a.strings()}$("#datalab-type").attr("disabled","disabled")},a.historyMessage=function(a){a.history_change_save?$("#datalab-change-storage").iCheck("check"):$("#datalab-change-storage").iCheck("uncheck"),"boolean"===a.tag_type||$("#datalab-his-siquval").val(a.history_dead_zone_value),a.history_time?$("#datalab-fixed-storage").iCheck("check"):$("#datalab-fixed-storage").iCheck("uncheck"),$("#datalab-fixed-val").val(a.history_time_value);var e=$("#datalab-sec-min");switch(a.history_time_unit){case 1:e.val("1");break;case 2:e.val("2")}},a.IntergerAndFloatMessage=function(e){e.energy_data?$("#datalab-nenghao").iCheck("check"):$("#datalab-nenghao").iCheck("uncheck"),$("#datalab-defaultvalue").val(e.init_data),$("#datalab-maxval").val(e.max_value),$("#datalab-minval").val(e.min_value),$("#datalab-chengyival").val(e.multiply_by),e.alarm_dead_zone?$("#datalab-siqu").iCheck("check"):$("#datalab-siqu").iCheck("uncheck"),$("#datalab-siquval").val(e.alarm_dead_zone_value);var t=e.alarm_attributes;a.delete_warn.length=0;for(var l in t){var i='<tr data-id="'+t[l].id+'"><td><select style="width:60px;" class ="form-control select-sign"><option value ="2">></option><option value ="3"><</option></select></td><td><input class="form-control select-value" type="number"  onkeyup="checkjiexian(this)"  maxlength="9" style="border:none;" value="'+t[l].value+'"></td><td><select style="width:65px;" class = "form-control select-level"><option value = "3">高</option><option value = "2">中</option><option value = "1">低</option></select></td><td><input class="form-control select-desc" type="text" style="border:none;" value="'+t[l].message+'"></td><td data-id="'+t[l].id+'" class="warn-delete">删除</td></tr>';$("#table-warn tbody").append(i),$("#table-warn tbody tr").each(function(a,e){Number(l)===Number(a)&&($(e).find("select.select-sign").val(t[l].alarm_operator),$(e).find("select.select-level").val(t[l].alarm_level))}),$("#table-warn tbody tr").length>0&&$("#datalab-siqu").iCheck("enable")}},a.IntergerAndFloatSave=function(){var a,e,t=[];return a=!!$("#datalab-siqu").is(":checked"),e=!!$("#datalab-nenghao").is(":checked"),$("#table-warn tbody tr").each(function(a,e){var l={};""===$(this).data("id")||(l.id=$(this).data("id")),l.alarm_operator=$(this).find("select.select-sign").val(),l.value=$(this).find("input.select-value").val(),l.alarm_level=$(this).find("select.select-level").val(),l.message=$(this).find("input.select-desc").val(),l.alarm_status=1,l.delete=!1,t.push(l);for(var i in datalabel.delete_warn)t.push(datalabel.delete_warn[i])}),{energy_data:e,max_value:$("#datalab-maxval").val(),min_value:$("#datalab-minval").val(),multiply_by:$("#datalab-chengyival").val(),alarm_dead_zone:a,alarm_dead_zone_value:$("#datalab-siquval").val(),alarm_attributes:t}},a.saveDataLabel=function(){var e,t,l,i,n,d;e=!!$("#datalab-readonly").is(":checked"),d=!!$("#datalab-change-storage").is(":checked"),i=!!$("#datalab-fixed-storage").is(":checked"),t=$("#datalab-his-siquval").val(),n=$("#datalab-fixed-val").val(),l=$("#datalab-sec-min").val();var s={name:$("#datalab-name").val(),tag_type:$("#datalab-type").val(),energy_data:!1,description:$("#datalab-des").val(),node_id:$("#datalab-node").val(),point_id:$("#datalab-register").val(),is_readonly:e,collect_ode:$("#datalab-acquisition-style").val(),collect_nterval:$("#datalab-acquisition-frequency").val()};switch($("#datalab-type").val()){case"1":switch(Number($("#datalab-defaultvalue-switch").val())){case 1:s.init_data=1;break;case 0:s.init_data=0}var r;r=$("#datalab-warn").is(":checked")?1:0;var o=[];o.push({alarm_status:r,value:$("#datalab-warn-val").val(),alarm_level:$("#datalab-warn-level").val(),message:$("#datalab-warn-des").val(),alarm_operator:1}),o[0].delete=!r,""===$("#datalab-warn").data("id")||(o[0].id=$("#datalab-warn").data("id")),s.alarm_attributes=o,s.history_change_save=d,s.history_time=i,s.history_time_value=n,s.history_time_unit=l;break;case"2":case"3":var c=a.IntergerAndFloatSave();s.energy_data=c.energy_data,s.init_data=$("#datalab-defaultvalue").val(),s.max_value=c.max_value,s.min_value=c.min_value,s.multiply_by=c.multiply_by,s.alarm_attributes=c.alarm_attributes,s.alarm_dead_zone=c.alarm_dead_zone,s.alarm_dead_zone_value=c.alarm_dead_zone_value,s.history_change_save=d,s.history_time=i,s.history_time_value=n,s.history_time_unit=l,s.history_dead_zone_value=t;break;case"4":s.init_data=$("#datalab-defaultvalue").val()}return s},a.loadNode=function(){$.ajax({url:apiurl+"node",type:"get",dataType:"json",success:function(a){if(1==a.success){var e=a.data.items;for(var t in e)$("#datalab-node").append("<option value='"+e[t].id+"'>"+e[t].name+"</option>")}else layer.msg(a.error_message)},error:function(a){layer.msg(a.error_message),returnLogIn(a)}})},a.creatDatalabel=function(e){$.ajax({url:apiurl+"tag",type:"post",dataType:"json",data:e,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(layer.msg("创建成功"),is_save_go?($("#layer-new-datalabel").mCustomScrollbar("scrollTo","top"),a.cleanInput(),$("#btn-save").data("id",""),$("#btn-save").data("type","add"),$("#datalab-warn").data("id",""),$("#datalab-type").removeAttr("disabled")):layer.close(layer_open),""===$("#content-search-input").val()?a.shujubiaoqianLoadData(!1,a.savePage):a.shujubiaoqianLoadData(!0,a.savePage)):layer.msg(e.error_message)},error:function(a){publicAjaxError(a)}})},a.editDatalabels=function(e){$.ajax({url:apiurl+"tag",type:"PUT",dataType:"json",data:e,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){$(".loading").hide(),e.success?(layer.msg("编辑成功"),layer.close(layer_open),""===$("#content-search-input").val()?a.shujubiaoqianLoadData(!1,a.savePage):a.shujubiaoqianLoadData(!0,a.savePage),a.cleanInput(),$("#btn-save").data("id",""),$("#btn-save").data("type","add"),$("#datalab-warn").data("id",""),$("#datalab-type").removeAttr("disabled")):layer.msg(e.error_message)},error:function(a){publicAjaxError(a)}})},a.icheckInte=function(){$(".ckss").iCheck("destroy"),$(".ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"})},a.cleanInput=function(){$(".clean-input").val(""),$(".ckss-edit").iCheck("uncheck"),$("select option:first").prop("selected","selected"),$(".datalabel-edit .content > div:not(:nth-child(1))").show(),$("#table-warn tbody").html(""),$("#datalab-acquisition-style").val("1"),$("#datalab-acquisition-frequency").attr("disabled","disabled"),$("#datalab-acquisition-frequency").val(""),a.booleans()},a.booleans=function(){$(".lab-checkbox").hide(),$("#datalab-defaultvalue").hide(),$("#datalab-defaultvalue-switch").show(),$(".warn-parts").show(),$(".history-parts").show(),$(".div-switch-warn").show(),$(".div-other-warn").hide(),$(".datalabel-edit .content > div").show()},a.strings=function(){$(".lab-checkbox").hide(),$("#datalab-defaultvalue").show(),$("#datalab-defaultvalue-switch").hide(),$(".warn-parts").hide(),$(".history-parts").hide(),$(".datalabel-edit .content > div:not(:nth-child(1))").hide()},a.integerAndFloat=function(){$(".lab-checkbox").show(),$("#datalab-defaultvalue").show(),$("#datalab-defaultvalue-switch").hide(),$(".warn-parts").show(),$(".history-parts").show(),$(".div-switch-warn").hide(),$(".div-other-warn").show(),$(".datalabel-edit .content > div").show()},a}(datalabel),$("#clearImage").on("click",function(){$("#content-search-input").val(""),datalabel.shujubiaoqianLoadData(!1,1)}),$("#content-search-input").on("input",function(){""===$("#content-search-input").val()?datalabel.shujubiaoqianLoadData(!1,1):datalabel.shujubiaoqianLoadData(!0,1)});var layer_open,is_save_go;$("#datalabel_creat").on("click",function(){datalabel.delete_warn.length=0,layer_open=layer.open({title:["新建标签","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["60%","80%"],content:$("#layer-new-datalabel"),shift:2,move:!1,btn:["保存并继续","保存","放弃"],success:function(){$(".layui-layer-btn .layui-layer-btn1").css({background:"#DEE2FF",color:"#000000"}),$(".layui-layer-btn .layui-layer-btn2").css({background:"#3F446E",color:"#fff",border:"none"}),datalabel.cleanInput(),$("#btn-save").data("id",""),$("#btn-save").data("type","add"),$("#datalab-warn").data("id",""),$("#datalab-type").removeAttr("disabled")},yes:function(a){is_save_go=!0,$("#btn-save").click()},btn2:function(a){return is_save_go=!1,$("#btn-save").click(),!1},btn3:function(a){datalabel.cleanInput(),layer.close(a)}})}),$("#datalabel-tbodys").on("click","a.delete-datalabel",function(){$this=$(this),layer.open({title:["删除数据标签","font-size:18px;color:#fff;background:#3E4687;border:none;height:50px;font-weight:bold;line-height:50px;padding-left:10px"],type:1,skin:"layui-primary",area:["600px","200px"],content:$("#layer-delete-node"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$("#layer-delete-node p").text("确认删除该标签吗")},yes:function(a){var e=[$this.data("id")];datalabel.deleteTag(e),layer.close(a)},btn2:function(a){layer.close(a)}})}),$("#datalabel_delete").on("click",function(){var a=!1;if($("input[name='ckss']:checkbox").each(function(e,t){if($(t).is(":checked"))return a=!0,!1}),a){$this=$(this);layer.open({title:["删除数据标签","font-size:18px;color:#fff;background:#3E4687;border:none;height:50px;font-weight:bold;line-height:50px;padding-left:10px"],type:1,skin:"layui-primary",area:["600px","200px"],content:$("#layer-delete-node"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$("#layer-delete-node p").text("确认删除所有选中的标签吗")},yes:function(a){var e=[];$("input[name='ckss']:checkbox").each(function(a,t){$(t).is(":checked")&&e.push($(t).data("id"))}),datalabel.deleteTag(e),layer.close(a)},btn2:function(a){layer.close(a)}})}else layer.msg("请至少选择一个标签")}),$("#datalabel-tbodys").on("click","a.edit-datalabel",function(){$("#btn-save").data("id",$(this).data("id")),$("#btn-save").data("type","edit"),datalabel.cleanInput(),datalabel.oneTagMessage($(this).data("id"))}),$("#btn-save").on("click",function(){var a,e,t=!0,l=datalabel.saveDataLabel(),i=!1;switch($(".input-must-fill").each(function(a,e){if(""===$(e).val())return t=!1,!1}),$("#datalab-type").val()){case"1":a="type-one",e="type-select";break;case"2":case"3":a="type-two",e="type-input",i=!0;break;case"4":a="type-one",e="type-input"}if(t)switch(e){case"type-select":$("#datalab-warn").is(":checked")&&""===$("#datalab-warn-des").val()?layer.msg("报警描述不能为空"):"1"===$("#datalab-acquisition-style").val()?checkOne(a,l):""===$("#datalab-acquisition-frequency").val()?layer.msg("采集频率不能为空"):checkOne(a,l);break;case"type-input":if(""===$("#datalab-defaultvalue").val())layer.msg("默认值不能为空");else if(i)if(""===$("#datalab-maxval").val()&&""===$("#datalab-minval").val())"1"===$("#datalab-acquisition-style").val()?checkOne(a,l):""===$("#datalab-acquisition-frequency").val()?layer.msg("采集频率不能为空"):checkOne(a,l);else{var n=Number($("#datalab-maxval").val()),d=Number($("#datalab-minval").val());n<=999999999&&d>=-999999999&&n>d?"1"===$("#datalab-acquisition-style").val()?checkOne(a,l):""===$("#datalab-acquisition-frequency").val()?layer.msg("采集频率不能为空"):checkOne(a,l):layer.msg("最大值最小值不准确")}else"1"===$("#datalab-acquisition-style").val()?checkOne(a,l):""===$("#datalab-acquisition-frequency").val()?layer.msg("采集频率不能为空"):checkOne(a,l)}else layer.msg("必填项不能为空")}),$("#datalab-addlimit").on("click",function(){if($("#table-warn tbody tr").length<8){$("#table-warn tbody").append('<tr data-id=""><td><select style="width:60px;" class ="form-control select-sign"><option value = "2" selected = "selected">></option><option value = "3"><</option></select></td><td><input class="form-control select-value" type="text"  maxlength="9" onkeyup="checkjiexian(this)" style="border:none;" ></td><td><select style="width:65px;" class = "form-control select-level" value = ""><option value = "1">高</option><option value = "2">中</option><option value = "3">低</option></select></td><td><input class="form-control select-desc" type="text" style="border:none;"></td><td data-id="" class="warn-delete">删除</td></tr>'),$("#datalab-siqu").iCheck("enable")}else layer.msg("最多8条报警")}),$("#table-warn tbody").on("click","td.warn-delete",function(){var a=$(this).data("id");""!==a&&datalabel.delete_warn.push({id:a,delete:!0}),$(this).parent().remove(),$("#table-warn tbody").html()||($("#datalab-siqu").iCheck("uncheck"),$("#datalab-siqu").iCheck("disable"))}),$("#datalab-warn").on("ifChanged",function(a){$(this).is(":checked")?($("#datalab-warn-val").removeAttr("disabled"),$("#datalab-warn-level").removeAttr("disabled"),$("#datalab-warn-des").removeAttr("disabled")):($("#datalab-warn-val").attr("disabled","disabled"),$("#datalab-warn-level").attr("disabled","disabled"),$("#datalab-warn-des").attr("disabled","disabled"))}),$("#datalab-siqu").on("ifChanged",function(a){$(this).is(":checked")?$("#datalab-siquval").removeAttr("disabled"):$("#datalab-siquval").attr("disabled","disabled")}),$("#datalab-change-storage").on("ifChanged",function(a){$(this).is(":checked")?$("#datalab-his-siquval").removeAttr("disabled"):$("#datalab-his-siquval").attr("disabled","disabled")}),$("#datalab-fixed-storage").on("ifChanged",function(a){$(this).is(":checked")?$("#datalab-fixed-val").removeAttr("disabled"):$("#datalab-fixed-val").attr("disabled","disabled")}),$("#datalab-type").on("change",function(){switch($(this).val()){case"1":datalabel.booleans();break;case"2":case"3":datalabel.integerAndFloat();break;case"4":datalabel.strings()}}),$("#datalab-acquisition-style").on("change",function(){var a=$("#datalab-acquisition-frequency");switch($(this).val()){case"1":a.attr("disabled","disabled"),a.val("");break;case"2":case"3":a.removeAttr("disabled")}});
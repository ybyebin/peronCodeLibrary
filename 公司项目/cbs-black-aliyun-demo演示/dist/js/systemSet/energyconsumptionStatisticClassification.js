function Initialize(e){groups="";var a=apiurl+"project",i=apiurl+"EnergyConfigClassification/0";$.ajax({url:a,type:"get",dataType:"json",beforeSend:function(){$(".loading").show()},success:function(a){a.success?($("#logo").attr("src",a.data.logo_path),$.ajax({url:i,type:"GET",success:function(i){i.success?(e&&classificationTree("tree",a,i,icheckInitialize),classificationTree("trees",a,i,icheckInitializeDisplay)):layer.msg(data.error_message)},error:function(e){publicAjaxError(e)}})):layer.msg(a.error_message)},error:function(e){publicAjaxError(e)}})}function icheckInitialize(){$(".tree-ckss").iCheck("destroy"),$(".tree-ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),$(".tree-ckss-son").iCheck("disable"),$(".loading").hide()}function icheckInitializeDisplay(){$(".trees-ckss").iCheck("destroy"),$(".trees-ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"icheckbox_square-green",increaseArea:"20%"}),$(".trees-ckss").iCheck("disable"),$(".loading").hide(),groups=checkGroups()}function icheckInitializeAlert(){$(".alert-ckss").iCheck("destroy"),$(".alert-ckss").iCheck({checkboxClass:"icheckbox_square-green",increaseArea:"20%"})}function classificationTree(e,a,i,t){if(null===i.data.items)return void $(".loading").hide();$("#"+e).html("");var s="";s+='<div class="panel panel-default" style="margin-right: 0;text-align:left"><div class="panel-heading"><h4 class="panel-title"><a href="#'+e+"-"+a.data.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle" aria-expanded="true  pointGroups-name">'+a.data.name+"</a></h4></div>",s+='<div class="panel-collapse collapse in" id="'+e+"-"+a.data.id+'" aria-expanded="false" ><div class="panel-body '+e+'classification-main-body">',$.each(i.data.items,function(a,i){var t,d,l;d=!i.hide_tag,l=!!i.next_level,t=!1===l&&!1===d?"":"add","tree"===e&&(t=""),s+='<div class="first panel panel-default '+e+"-"+i.id+'"><div class="panel-heading fang" style="padding-left:0;padding-right:0px;" ><h4 class="panel-title">',s+='<a  href="#'+e+"-s"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="one-step accordion-toggle '+t+' pointGroups-a" aria-expanded="true">',s+='<input name="tree-ckss" data-parid="'+e+"-s"+i.id+'"   data-hidetag="'+i.hide_tag+'"   data-step="'+e+'-first" tabindex="5" type="radio" id="'+e+"-"+i.id+"-"+a+'"  class="skin-square-green fu '+e+'-ckss"  data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+'<span data-step="'+e+'-first" data-id="'+e+"-"+i.id+'" data-groupid="'+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="first-body panel-collapse collapse in " id="'+e+"-s"+i.id+'" aria-expanded="true">',i.next_level&&$.each(i.next_level,function(a,i){var t,d,l;d=!i.hide_tag,l=!!i.next_level,t=!1===l&&!1===d?"":"add","tree"===e&&(t=""),s+='<div class="second panel panel-default '+e+"-"+i.id+'" ><div class="panel-heading fang" style="margin-left: 15px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+='<a  href="#'+e+"-s"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+t+' pointGroups-a" aria-expanded="false">',s+='<input name="tree-ckss" data-parid="'+e+"-s"+i.id+'" data-hidetag="'+i.hide_tag+'"   data-step="'+e+'-second" tabindex="5" type="radio" id="'+e+"-"+i.id+"-"+a+'"  class="skin-square-green fu '+e+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+'<span data-step="'+e+'-second" data-id="'+e+"-"+i.id+'"  data-groupid="'+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="second-body panel-collapse collapse " id="'+e+"-s"+i.id+'" aria-expanded="false" style="height: 0px;">',i.next_level&&$.each(i.next_level,function(a,i){var t,d,l;d=!i.hide_tag,l=!!i.next_level,t=!1===l&&!1===d?"":"add","tree"===e&&(t=""),s+='<div class="third panel panel-default '+e+"-"+i.id+'" style="padding-left:15px;"><div class="panel-heading fang" style="padding-left:45px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+='<a  href="#'+e+"-s"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+t+' pointGroups-a" aria-expanded="false">',s+='<input name="tree-ckss" data-parid="'+e+"-"+i.id+'"  data-hidetag="'+i.hide_tag+'"  data-step="'+e+'-third" tabindex="5" type="radio" id="'+e+"-"+i.id+"-"+a+'"  class="skin-square-green fu '+e+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+'<span data-step="'+e+'-third" data-id="'+e+"-"+i.id+'" data-groupid="'+i.id+'"    class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="thrid-body panel-collapse collapse " id="'+e+"-s"+i.id+'" aria-expanded="false" style="height: 0px;padding-left:45px;">',s+="</div>"}),s+="</div>"}),s+="</div>"}),s+="</div></div>",$("#"+e).append(s),"tree"===e&&$("#"+e).mCustomScrollbar(),t()}function deleteGroups(e){switch(e.data("step")){case"tree-first":case"tree-second":groups[e.data("groupid")].level=0,groups[e.data("groupid")].higher_level=0,$("#"+e.data("id")).find("span.classification-delete").each(function(e,a){groups[$(a).data("groupid")].level=0,groups[$(a).data("groupid")].higher_level=0});break;case"tree-third":groups[e.data("groupid")].level=0,groups[e.data("groupid")].higher_level=0}$("."+e.data("id")).remove(),$("#"+e.data("id")).remove()}function deleteGroupLayer(e,a){layer.open({title:["确认删除","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["600px","200px"],content:$("#classification-delete-group"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$("#classification-delete-group p").text(a)},yes:function(a){deleteGroups(e),layer.close(a)},btn2:function(e){layer.close(e)}})}function loadGroups(e){$.ajax({url:apiurl+"energyconfig?name="+e,type:"GET",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(e){if($(".loading").hide(),e.success){var a=[];if(null!==e.data.items&&(a=e.data.items),$(".alert-body").html(""),0!==a.length){$(".alert-table").show(),$(".alert-nodata").hide();for(var i=0;i<a.length;i++){var t="<tr><td>"+a[i].name+'</td><td><input id="'+a[i].id+'" type="checkbox" class="alert-ckss" name="alert-ckss" /></td></tr>';$(".alert-body").append(t)}icheckInitializeAlert()}else $(".alert-table").hide(),$(".alert-nodata").show()}else layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}function checkGroups(){var e={};return $('input[data-step="tree-first"]').each(function(a,i){e[$(i).data("id")]={id:$(i).data("id"),hide_tag:$(i).data("hidetag"),level:1,higher_level:0},$("#"+$(i).data("parid")+' input[data-step="tree-second"]').each(function(a,t){e[$(t).data("id")]={id:$(t).data("id"),hide_tag:$(t).data("hidetag"),level:2,higher_level:$(i).data("id")},$("#"+$(t).data("parid")+' input[data-step="tree-third"]').each(function(a,i){e[$(i).data("id")]={id:$(i).data("id"),hide_tag:$(i).data("hidetag"),level:3,higher_level:$(t).data("id")}})})}),e}var groups;$(function(){Initialize(!0)}),$("#btn-edit").on("click",function(){$("#classification-main-form").hide(),$("#classification-edit-form").show(),Initialize(!0)}),$("#btn-cancle").on("click",function(){$("#classification-main-form").show(),$("#classification-edit-form").hide(),$("loading").hide()}),$("#btn-save").on("click",function(){var e=[];for(var a in groups)e.push(groups[a]);$.ajax({url:apiurl+"EnergyConfigClassification",type:"PUT",dataType:"json",data:{energy_configs:e},beforeSend:function(){$(".loading").show()},success:function(e){$(".loading").hide(),e.success?(Initialize(!1),$("#classification-main-form").show(),$("#classification-edit-form").hide()):layer.msg(e.error_message)},error:function(e){publicAjaxError(e)}})}),$("#add-samelevemenu-btn").on("click",function(){if($(".treeclassification-main-body").children().length){var e=[];if($('input[name="tree-ckss"]:checked').hasClass("fu")){var a=$('input[name="tree-ckss"]:checked'),i=a.parent().parent().parent().parent().parent().parent(),t={id:a.parent().parent().attr("href"),type:a.data("step")};switch(a.data("step")){case"tree-first":t.brother=Number($(".treeclassification-main-body").find("div.first").length),t.groupid=0;break;case"tree-second":t.brother=Number(i.find("div.second").length),t.groupid=i.attr("id").substring(5);break;case"tree-third":i.find("div.third").length&&(t.brother=Number(i.find("div.third").length)),t.groupid=i.attr("id").substring(5)}e.push(t)}0===e.length?layer.msg("请选择一个组"):layer.open({title:["选择添加组","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["700px","625px"],content:$("#classification-groups"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$(".alert-body").html(""),$("#content-search-input").val("")},yes:function(a){var i=checkGroups(),s=[];$('input[name="alert-ckss"]:checked').each(function(e,a){Number($(a).attr("id"));s.push(Number($(a).attr("id")))});var d=!1;if(0!==Number(s.length)){for(var l in s)if(i[s[l]]){d=!0;break}if(d)layer.msg("不能选择已添加的群组");else{var n=apiurl+"EnergyConfigClassification/1?ids="+s.join(",");$.ajax({url:n,type:"GET",beforeSend:function(){$(".loading").show()},success:function(i){if(i.success)switch(layer.close(a),e[0].type){case"tree-first":var s="",d="tree",l="";$.each(i.data.items,function(a,i){groups[i.id]={id:i.id,hide_tag:i.hide_tag,level:1,higher_level:0};var t=e[0].brother+1+a;s+='<div class="first panel panel-default '+d+"-"+i.id+'"><div class="panel-heading fang" style="padding-left:0;padding-right:0px;" ><h4 class="panel-title">',s+='<a  href="#'+d+"-"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="one-step accordion-toggle collapsed '+l+' pointGroups-a" aria-expanded="false">',s+='<input name="tree-ckss" data-parid="'+d+"-"+i.id+'" data-hidetag="'+i.hide_tag+'" data-step="tree-first" tabindex="5" type="radio" id="'+d+"-"+i.id+"-"+t+'"  class="skin-square-green fu '+d+'-ckss"  data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+'<span data-step="tree-first" data-groupid="'+i.id+'" data-id="'+d+"-"+i.id+'"    class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="first-body panel-collapse collapse " id="'+d+"-"+i.id+'" aria-expanded="false">',s+="</div>"}),$(s).insertAfter($(e[0].id)),icheckInitialize();break;case"tree-second":var s="",d="tree",l="";$.each(i.data.items,function(a,i){groups[i.id]={id:i.id,hide_tag:i.hide_tag,level:2,higher_level:t.groupid};var n=e[0].brother+1+a;s+='<div class="second panel panel-default '+d+"-"+i.id+'" ><div class="panel-heading fang" style="margin-left: 15px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+='<a  href="#'+d+"-"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+l+' pointGroups-a" aria-expanded="false">',s+='<input name="tree-ckss"   data-hidetag="'+i.hide_tag+'" data-step="tree-second" tabindex="5" type="radio" id="'+d+"-"+i.id+"-"+n+'"  class="skin-square-green fu '+d+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+' <span data-step="tree-second" data-groupid="'+i.id+'" data-id="'+d+"-"+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="second-body panel-collapse collapse " id="'+d+"-"+i.id+'" aria-expanded="false" style="height: 0px;">',s+="</div>"}),$(s).insertAfter($(e[0].id)),icheckInitialize();break;case"tree-third":var s="",d="tree",l="";$.each(i.data.items,function(a,i){groups[i.id]={id:i.id,hide_tag:i.hide_tag,level:3,higher_level:t.groupid};var n=e[0].brother+1+a;s+='<div class="third panel panel-default '+d+"-"+i.id+'" style="padding-left:15px;"><div class="panel-heading fang" style="padding-left:45px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',s+='<a  href="#'+d+"-"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+l+' pointGroups-a" aria-expanded="false">',s+='<input name="tree-ckss"  data-hidetag="'+i.hide_tag+'"  data-step="tree-third" tabindex="5" type="radio" id="'+d+"-"+i.id+"-"+n+'"  class="skin-square-green fu '+d+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+' <span data-step="tree-third" data-groupid="'+i.id+'" data-id="'+d+"-"+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',s+='<div class="thrid-body panel-collapse collapse " id="'+d+"-"+i.id+'" aria-expanded="false" style="height: 0px;padding-left:45px;">',s+="</div>"}),$(s).insertAfter($(e[0].id)),icheckInitialize()}else layer.msg(i.error_message)},error:function(e){publicAjaxError(data)}})}}else layer.msg("未选择任何数据")},btn2:function(e){layer.close(e)}})}else layer.msg("无任何组,请点击添加子菜单添加")}),$("#add-sonlevemenu-btn").on("click",function(){if($(".treeclassification-main-body").children().length)if($('input[name="tree-ckss"]:checked').hasClass("fu")){var e=$('input[name="tree-ckss"]:checked'),a={id:e.parent().parent().attr("href"),type:e.data("step"),groupid:e.data("id")};"tree-third"===e.data("step")?layer.msg("三级菜单无子菜单"):layer.open({title:["选择添加组","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["700px","625px"],content:$("#classification-groups"),shift:2,move:!1,btn:["确定","放弃"],success:function(){$(".alert-body").html(""),$("#content-search-input").val("")},yes:function(i){var t=[];$('input[name="alert-ckss"]:checked').each(function(e,a){t.push(Number($(a).attr("id")))});var s=checkGroups(),d=!1;if(0!==Number(t.length)){for(var l in t)if(s[t[l]]){d=!0;break}if(d)layer.msg("不能选择已添加的群组");else{var n=apiurl+"EnergyConfigClassification/1?ids="+t.join(",");$.ajax({url:n,type:"GET",beforeSend:function(){$(".loading").show()},success:function(t){if(t.success)switch(layer.close(i),e.data("step")){case"tree-first":a.brother=Number($("#tree "+a.id+" div.second").length),0===a.brother?a.lastson_id=a.id:a.lastson_id=$($("#tree "+a.id+" div.second")[a.brother-1]).attr("class").split(" ").pop();var s="tree",d="",l="",n=a.brother+1;$.each(t.data.items,function(e,i){groups[i.id]={id:i.id,hide_tag:i.hide_tag,level:2,higher_level:a.groupid},n=a.brother+e,d+='<div class="second panel panel-default '+s+"-"+i.id+'" ><div class="panel-heading fang" style="margin-left: 15px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',d+='<a  href="#'+s+"-"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+l+' pointGroups-a" aria-expanded="false">',d+='<input name="tree-ckss" data-hidetag="'+i.hide_tag+'" data-step="tree-second" tabindex="5" type="radio" id="'+s+"-"+i.id+"-"+n+'"  class="skin-square-green fu '+s+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+' <span data-groupid="'+i.id+'" data-step="tree-second" data-id="'+s+"-"+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',d+='<div class="second-body panel-collapse collapse " id="'+s+"-"+i.id+'" aria-expanded="false">',d+="</div>"}),0===a.brother?$(a.lastson_id).prepend(d):$("#"+a.lastson_id).after(d),icheckInitialize();break;case"tree-second":a.brother=Number($("#tree "+a.id+" div.third").length),0===a.brother?a.lastson_id=a.id:a.lastson_id=$($("#tree "+a.id+" div.third")[a.brother-1]).attr("class").split(" ").pop();var s="tree",d="",n=a.brother+1;$.each(t.data.items,function(e,i){groups[i.id]={id:i.id,hide_tag:i.hide_tag,level:3,higher_level:a.groupid},n=a.brother+e,d+='<div class="third panel panel-default '+s+"-"+i.id+'" style="padding-left:30px;"><div class="panel-heading fang" style="padding-left:30px;padding-top:5px;padding-right:0;"><h4 class="panel-title ">',d+='<a  href="#'+s+"-"+i.id+'" data-parent="#accordion" data-toggle="collapse" class="accordion-toggle collapsed '+l+' pointGroups-a" aria-expanded="false">',d+='<input name="tree-ckss" data-hidetag="'+i.hide_tag+'" data-step="tree-third" tabindex="5" type="radio" id="'+s+"-"+i.id+"-"+n+'"  class="skin-square-green fu '+s+'-ckss" data-id="'+i.id+'" ><label  class="form-label pointGroups-label">'+i.name+' <span data-groupid="'+i.id+'" data-step="tree-third" data-id="'+s+"-"+i.id+'"   class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',d+='<div class="thrid-body panel-collapse collapse " id="'+s+"-"+i.id+'" aria-expanded="false" style="height: 0px;padding-left:45px;">',d+="</div>"}),0===a.brother?$(a.lastson_id).prepend(d):$("#"+a.lastson_id).after(d),icheckInitialize()}else layer.msg(t.error_message),returnLogIn(t.error_message)},error:function(e){layer.msg(e.error_message)}})}}else layer.msg("未选择任何群组")},btn2:function(e){layer.close(e)}})}else layer.msg("请选择一个组");else layer.open({title:["选择添加组","font-size:18px;color:#fff;background:#3E4687;height:50px;font-weight:bold;line-height:50px;padding-left:30px;border:none;"],type:1,skin:"layui-primary",area:["700px","625px"],content:$("#classification-groups"),shift:2,move:!1,btn:["确定","放弃"],success:function(){},yes:function(e){var a=[];$('input[name="alert-ckss"]:checked').each(function(e,i){a.push(Number($(i).attr("id")))});var i=apiurl+"EnergyConfigClassification/1?ids="+a.join(",");0===a.length?layer.msg("未选择能耗组"):$.ajax({url:i,type:"GET",beforeSend:function(){$(".loading").show()},success:function(a){if($(".loading").hide(),a.success){layer.close(e);var i="";$.each(a.data.items,function(e,a){groups[a.id]={id:a.id,hide_tag:a.hide_tag,level:1,higher_level:0},i+='<div class="first panel panel-default tree-'+a.id+'"><div class="panel-heading fang" style="padding-left:0;padding-right:0px;" ><h4 class="panel-title">',i+='<a  href="#tree-'+a.id+'" data-parent="#accordion" data-toggle="collapse" class="one-step accordion-toggle collapsed  pointGroups-a" aria-expanded="false">',i+='<input name="tree-ckss" data-parid="tree-'+a.id+'"  data-hidetag="'+a.hide_tag+'" data-step="tree-first" tabindex="5" type="radio" id="tree-'+a.id+"-"+e+'"  class="skin-square-green fu tree-ckss"  data-id="'+a.id+'" ><label  class="form-label pointGroups-label">'+a.name+'<span data-groupid="0" data-step="tree-first" data-id="tree-'+a.id+'"    class="classification-delete" style="float:right">删除</span></label></a></h4></div></div>',i+='<div class="first-body panel-collapse collapse " id="tree-'+a.id+'" aria-expanded="false" style="height: 0px;">',i+="</div>"}),$(".treeclassification-main-body").append(i),icheckInitialize()}else layer.msg(a.error_message)},error:function(e){publicAjaxError(e)}})},btn2:function(e){layer.close(e)}})}),$("body").on("click","span.classification-delete",function(e){e&&e.stopPropagation&&e.stopPropagation();var a=$(this),i="该组带有子菜单,确认要删除吗?";switch($(this).data("step")){case"tree-first":$("#"+$(this).data("id")).find("div.second").length>0?deleteGroupLayer(a,i):deleteGroupLayer(a,"确认要删除吗?");break;case"tree-second":$("#"+$(this).data("id")).find("div.third").length>0?deleteGroupLayer(a,i):deleteGroupLayer(a,"确认要删除吗?");break;case"tree-third":deleteGroupLayer(a,"确认要删除吗?")}}),$("#content-search-input").on("input",function(){loadGroups($("#content-search-input").val())}),$("#search-span").on("click",function(){loadGroups($("#content-search-input").val())}),$("#clearImage").on("click",function(){$("#content-search-input").val(""),loadGroups($("#content-search-input").val())});
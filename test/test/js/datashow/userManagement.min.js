/*! test 2017-04-13 */

function getUserMessage(){$.ajax({url:apiurl+"r=api/system/user/list",type:"post",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){$(".loading").hide(),a.success?addUserMessageToTable(a.data):(layer.msg(a.error_message),returnLogIn(a.error_message))},error:function(a){$(".loading").hide(),layer.msg(a.error_message),returnLogIn(a.error_message)}})}function addUserMessageToTable(a){if(null==a)a=[{id:""}];else for(var b in a)a[b].system_role_id="管理员";if(a.length<14)for(var c=14-a.length,d=0;d<c;d++){var e={id:""};a.push(e)}$("#user-message-tbody").html("");for(var f=$("#user-Message-tbody").html(),d=0;d<a.length;d++){if(""==a[d].id)var g='<tr data-id=""><td></td><td></td><td></td><td></td><td></td></tr>';else var g='<tr data-id = "'+a[d].id+'" ><td>'+a[d].username+"</td><td>"+a[d].system_role_id+"</td><td>"+a[d].full_name+"</td><td>"+a[d].employee_id+"</td><td>"+a[d].last_login_time+"</td></tr>";f+=g}$("#user-message-tbody").html(f),$("#user-message-tbody").children("tr").first().click()}function graphicImageGetData(){$.ajax({url:apiurl+"r=api/entity/subsys/list",type:"post",dataType:"json",beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){if($(".loading").hide(),a.success){for(var b in a.data){dicGroup[a.data[b].id]=a.data[b].id;var c='<li><input id="edit'+a.data[b].id+'" data-id="'+a.data[b].id+'" class="ckss" type="checkbox" name="user-edit-ckss"><label>'+a.data[b].name+"</label></li>",d='<li><input id="add'+a.data[b].id+'" data-id="'+a.data[b].id+'" class="ckss" type="checkbox" name="user-add-ckss"><label>'+a.data[b].name+"</label></li>";$(".edit-user-ul ul").append(c),$(".add-user-ul ul").append(d)}$(".ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),getUserMessage()}else layer.msg(a.error_message),returnLogIn(a.error_message)},error:function(a){$(".loading").hide(),layer.msg(a.error_message)}})}function getUseDetailedInformation(a){$.ajax({url:apiurl+"r=api/system/user/info",type:"post",dataType:"json",data:{data:JSON.stringify({user_id:a})},beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){if($(".loading").hide(),a.success){var b,c=a.data;switch(c.system_role_id){case"1":b="管理员";break;case"2":b="普通"}$(".display-cancel-user").data("id",c.id),$(".edit-save-user").data("id",c.id),$(".display-user-name").text(c.username),$(".display-role").text(b),$(".display-name").text(c.full_name),$(".display-staff-number").text(c.employee_id),$(".display-user-ul ul").html(""),$('.edit-user-ul input[name="user-edit-ckss"]').iCheck("uncheck");for(var d in c.user_view_group){var e='<li><input class="dis-ckss" type="checkbox" disabled="true" checked="checked"><label>'+c.user_view_group[d].view_group_name+"</label></li>";$(".display-user-ul ul").append(e),$(".dis-ckss").iCheck("destroy"),$(".dis-ckss").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),dicGroup[c.user_view_group[d].view_group_id]&&$("#edit"+c.user_view_group[d].view_group_id).iCheck("check")}$(".edit-save-user").data("id",c.id),$(".edit-name").val(c.username),$(".edit-psw").val(""),$(".eidt-surepsw").val(""),$(".edit-fullname").val(c.full_name),$(".edit-ygnumber").val(c.employee_id),$(".edituserjaose").val(c.system_role_id)}else layer.msg(a.error_message),returnLogIn(a.error_message)},error:function(a){$(".loading").hide(),layer.msg(a.error_message)}})}!function(a){a(window).load(function(){a(".user-message-div").mCustomScrollbar(),a(".display-user-ul").mCustomScrollbar(),a(".edit-user-ul").mCustomScrollbar(),a(".add-user-ul").mCustomScrollbar()})}(jQuery),$("#foot").load("public.html");var dicGroup={};$(function(){publicHeadfun(),graphicImageGetData()}),$("#user-message-tbody").on("click","tr",function(){""!==$(this).data("id")&&($(".message-div-detailed").hide(),$(".message-div-display").show(),$("#user-message-tbody tr").removeClass("actives"),$(this).addClass("actives"),getUseDetailedInformation($(this).data("id")))}),$("#btn-adduser").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-add").show(),$(".message-div-add input").val(""),$(".adduserjaose").val(1),$('.add-user-ul input[name="add-user-ckss"]').iCheck("unckeck")}),$(".add-save-user").on("click",function(){var a=$(".add-name").val(),b=$(".add-psw").val(),c=$(".add-surepsw").val(),d=[];if($('.add-user-ul input[name="user-add-ckss"]:checked').each(function(a,b){d.push($(b).data("id"))}),""!==a&&""!=b&&""!==c)if(b===c){var e={data:JSON.stringify({username:a,password:b,confirm_password:c,system_role_id:$(".adduserjaose").val(),full_name:$(".add-fullname").val(),employee_id:$(".add-ygnumber").val(),view_group_ids:d})};$.ajax({url:apiurl+"r=api/system/user/create",type:"post",dataType:"json",data:e,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){$(".loading").hide(),a.success?(layer.msg("创建成功"),getUserMessage(),$(".message-div-detailed").hide(),$(".message-div-display").show()):(layer.msg(a.error_message),returnLogIn(a.error_message))},error:function(a){$(".loading").hide(),layer.msg(a.error_message)}})}else layer.msg("两次输入的密码不一致,请重新输入");else layer.msg("请确认信息填写完整")}),$(".add-save-cancel").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-display").show()}),$(".display-edit-user").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-edit").show()}),$(".display-cancel-user").on("click",function(){layer.msg("删除"),""!==$(this).data("id")?$.ajax({url:apiurl+"r=api/system/user/delete",type:"post",dataType:"json",data:{data:JSON.stringify({user_id:$(this).data("id")})},beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){$(".loading").hide(),a.success?($(".message-div-display .center div label:nth-child(2)").text(""),$(".display-user-ul ul").html(""),layer.msg("删除成功"),getUserMessage()):(layer.msg(a.error_message),returnLogIn(a.error_message))},error:function(a){$(".loading").hide(),layer.msg(a.error_message)}}):layer.msg("请选中一条用户信息")}),$(".edit-save-user").on("click",function(){var a=$(".edit-name").val(),b=$(".edit-psw").val(),c=$(".eidt-surepsw").val(),d=[];if($('.edit-user-ul input[name="user-edit-ckss"]:checked').each(function(a,b){d.push($(b).data("id"))}),""!==a&&""!=b&&""!==c)if(b===c){var e={data:JSON.stringify({user_id:Number($(this).data("id")),username:a,password:b,confirm_password:c,system_role_id:$(".edituserjaose").val(),full_name:$(".edit-fullname").val(),employee_id:$(".edit-ygnumber").val(),view_group_ids:d})};$.ajax({url:apiurl+"r=api/system/user/update",type:"post",dataType:"json",data:e,beforeSend:function(){$(".loading").show()},complete:function(){$(".loading").hide()},success:function(a){$(".loading").hide(),a.success?(layer.msg("修改成功"),$(".message-div-detailed").hide(),$(".message-div-display").show(),getUserMessage()):(layer.msg(a.error_message),returnLogIn(a.error_message))},error:function(a){$(".loading").hide(),layer.msg(a.error_message)}})}else layer.msg("两次输入的密码不一致,请重新输入");else layer.msg("请确认信息填写完整")}),$(".edit-save-cancel").on("click",function(){$(".message-div-detailed").hide(),$(".message-div-display").show()});
/*! test 2017-04-13 */

function activeLastPointToolip(a){var b=1e9,c=0,d=[0,0],e=a.series[0].points;Highcharts.each(e,function(a){a.y>c&&(d[0]=a.index,c=a.y),null!=a.y&&a.y<b&&(d[1]=a.index,b=a.y)}),label_max+=1,label_min+=1,render_max(a,e[d[0]],'<br><span style="color:#B5A6B2">最大值</span>'),render_min(a,e[d[1]],'<br><span style="color:#B5A6B2">最小值</span>')}function render_max(a,b,c){console.log("查看最大值："+b.y),a.renderer.label(Number(b.y.toFixed(3))+"kw"+c,b.plotX+a.plotLeft-20,b.plotY+a.plotTop,"callout",b.plotX+a.plotLeft,b.plotY+a.plotTop).css({color:"#F1F2F3",align:"center"}).attr({zIndex:6,id:"label_max"+label_max}).add()}function render_min(a,b,c){labels=a.renderer.label(Number(b.y.toFixed(3))+"kw"+c,b.plotX+a.plotLeft-20,b.plotY+a.plotTop-45,"callout",b.plotX+a.plotLeft,b.plotY+a.plotTop).css({color:"#F1F2F3",align:"center"}).attr({zIndex:6,id:"label_min"+label_min}).add()}function getHomePageMessage(){$.ajax({url:apiurl+"r=api/main/demo",type:"post",dataType:"json",data:null,beforeSend:function(){$(".loading").show()},success:function(a){if($(".loading").hide(),a.success){console.log(JSON.stringify(a,null,2));var b=a.data.realTimeTag;for(var c in b)switch(Number(b[c].tagId)){case 1422:case 1423:case 1424:case 1425:case 1426:case 1427:changeValue.pointValue(b[c]);break;case 1428:case 1429:case 1430:case 1431:case 1432:case 1433:case 1434:case 1435:changeValue.footValue(b[c]);break;case 1436:case 1437:changeValue.titleValue(b[c]);break;case 1438:case 1440:changeValue.rightValue(b[c])}$("#1436 li:nth-child(2) p:first-child").text(a.data.target[0]),$("#1437 li:nth-child(2) p:first-child").text(a.data.target[1]),isNaN($("#1436 li:nth-child(1) p:first-child").text())?$("#1436 li:nth-child(3) p:first-child").text("0"):$("#1436 li:nth-child(3) p:first-child").text((Number($("#1436 li:nth-child(1) p:first-child").text())/Number(a.data.target[0])*100).toFixed(2)),isNaN($("#1437 li:nth-child(1) p:first-child").text())?$("#1437 li:nth-child(3) p:first-child").text("0"):$("#1437 li:nth-child(3) p:first-child").text((Number($("#1437 li:nth-child(1) p:first-child").text())/Number(a.data.target[1])*100).toFixed(2));var d=a.data.power.data,e=d;Highcharts.chart("container",{chart:{backgroundColor:"#292E46",plotBorderColor:"#30354E",plotBorderWidth:1,plotBackgroundImage:"images/cbsnew/总功率.png",events:{load:function(){chart=this;var a=this.series[0];tagValueSetInterval=setInterval(function(){if(addData){var b=real_time,c=real_time_value;a.addPoint([b,c],!0,!1),$("#label_min"+label_min).remove(),$("#label_max"+label_max).remove(),activeLastPointToolip(chart),addData=!1}},1e3)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"},visible:!1},tooltip:{dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%Y-%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:""},gridLineWidth:0},legend:{enabled:!1},plotOptions:{area:{fillColor:{linearGradient:{x1:0,y1:-5,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]},marker:{radius:2,enabled:!1},lineWidth:1,states:{hover:{lineWidth:1}},threshold:null}},series:[{type:"area",name:"总功率",data:e,lineWidth:.5,lineColor:"#438FBE"}]},function(a){a=this,0==e.length||activeLastPointToolip(a)}),MQTTconnect()}else console.log("错误原因"+JSON.stringify(a,null,2)),layer.msg(a.error_message),returnLogIn(a.error_message)},error:function(a){$(".loading").hide(),layer.msg(a.error_message),console.log("错误原因"+JSON.stringify(a,null,2))}})}function MQTTconnect(){var a={useSSL:!1,cleanSession:!1,onSuccess:function(){subscribeView()},onFailure:function(a){console.log("connect Failure"),setTimeout(MQTTconnect,reconnectTimeout)}};mqtt.onConnectionLost=onConnectionLost,mqtt.onMessageArrived=onMessageArrived,mqtt.connect(a)}function subscribeView(){mqtt.subscribe("Bayax/Push/"+view_id);var a=new Paho.MQTT.Message(view_id);a.destinationName="Bayax/View/"+clientID,a.qos=0,setIntvals=setInterval(function(){mqtt.send(a)},3e4)}function onConnectionLost(a){console.log("connect Lost:"+JSON.stringify(a,null,2)),clearInterval(setIntvals),setTimeout(MQTTconnect,reconnectTimeout)}function onMessageArrived(a){var b=JSON.parse(a.payloadString);switch(Number(b.tagId)){case 1422:case 1423:case 1424:case 1425:case 1426:case 1427:console.log("查看MQTT返回的数据:"+JSON.stringify(b,null,2)),changeValue_mqtt.pointValue(b);break;case 1428:case 1429:case 1430:case 1431:case 1432:case 1433:case 1434:case 1435:changeValue_mqtt.footValue(b);break;case 1436:case 1437:changeValue_mqtt.titleValue(b);break;case 1438:case 1440:changeValue_mqtt.rightValue(b);break;case 1442:console.log(b.value),addData=!0,real_time=new Date(b.time).format("yyyy-MM-dd hh:mm:ss"),real_time_value=Number(Number(b.value).toFixed(2))}}function changeBodyHeight(){Number(window.outerHeigth)===Number(screen.height)&&Number(window.outerWidth)==Number(screen.width)?$("body").css("padding-top","0"):$("body").css("padding-top","2%"),window.outerHeight===screen.availHeight&&window.outerWidth===screen.availWidth?$("body").css("padding-top","0"):$("body").css("padding-top","2%")}$("#foot").load("public.html"),$(function(){publicHeadfun(),getHomePageMessage()}),$(function(){$("#container-pie").highcharts({chart:{backgroundColor:"#292E46",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},credits:{enabled:!1},title:{text:""},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{distance:5,enabled:!0,format:"{point.percentage:.1f} %",style:{color:"#BFD3DF",fontSize:"11px",fontWeight:"bold",textOutline:"none"}},showInLegend:!0}},legend:{align:"left",layout:"vertical",verticalAlign:"middle",itemMarginBottom:8,itemStyle:{color:"#7A8FAC;",fontWeight:"bold"},x:-10,y:50},series:[{type:"pie",name:"能耗占比",data:[{name:"空调",y:37,color:"#1B70B0"},{name:"照明",y:28,color:"#298372"},{name:"办公",y:22,color:"#8268BE"},{name:"其他",y:13,color:"#5DBAC9"}]}]})});var label_max=0,label_min=0;$(".point-monitor p:last-child").hover(function(){console.log("距离上"+$(this).offset().top),console.log("距离下"+$(this).offset().left);var a=Number($(this).offset().top)-30,b=Number($(this).offset().left)+20,c=$('<div class="hover-tips"><p>'+$(this).data("name")+"</p></div>");$("body").append(c.css({top:a+"px",left:b+"px"}))},function(){$(".hover-tips").remove()});var changeValue={};changeValue=function(a){return a.pointValue=function(a){$("#"+a.tagId+" p:last-child").data("name",a.message),a.alarm&&($("#"+a.tagId+" p:first-child").hide(),$("#"+a.tagId+" p:last-child").show())},a.footValue=function(a){a.alarm?$("#"+a.tagId+" p:last-child").html('异常<img class="css3-warn" src="images/cbsnew/baojing.png">'):$("#"+a.tagId+" p:last-child").html("正常")},a.titleValue=function(a){isNaN(a.value)?$("#"+a.tagId+" li:first-child p:first-child").text("异常"):$("#"+a.tagId+" li:first-child p:first-child").text(a.value)},a.rightValue=function(a){isNaN(a.value)?$("#"+a.tagId).text("异常"):$("#"+a.tagId).text(a.value)},a}(changeValue);var changeValue_mqtt={};changeValue_mqtt=function(a){return a.pointValue=function(a){console.log("报警状态："+a.isAlarm),a.isAlarm?($("#"+a.tagId+" p:first-child").hide(),$("#"+a.tagId+" p:last-child").show()):($("#"+a.tagId+" p:first-child").show(),$("#"+a.tagId+" p:last-child").hide())},a.footValue=function(a){a.isAlarm?$("#"+a.tagId+" p:last-child").html('异常<img class="css3-warn" src="images/cbsnew/baojing.png">'):$("#"+a.tagId+" p:last-child").html("正常")},a.titleValue=function(a){if(isNaN(a.value))$("#"+a.tagId+" li:first-child p:first-child").html("异常"),$("#"+a.tagId+" li:nth-child(3) p:first-child").html("0");else{$("#"+a.tagId+" li:first-child p:first-child").html(a.value);var b=Number(a.value)/Number($("#"+a.tagId+" li:nth-child(2) p:first-child").text())*100;$("#"+a.tagId+" li:nth-child(3) p:first-child").html(b.toFixed(2))}},a.rightValue=function(a){$("#"+a.tagId).text(Number(a.value).toFixed(2))},a}(changeValue_mqtt);var addData=!1,real_time="",real_time_value=0,view_id="9999",mqtt,reconnectTimeout=2e3,clientID="123",timeout=!1,setIntvals;mqtt=new Paho.MQTT.Client("192.168.2.2",61614,String(parseInt(100*Math.random(),10))),$(".left-center-foot li a").on("click",function(){sessionStorage.setItem("device_viewid",$(this).data("id"))}),$(function(){changeBodyHeight()}),window.onresize=function(){changeBodyHeight()};